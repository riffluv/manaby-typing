(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[475],{1427:(e,t,r)=>{"use strict";r.d(t,{z:()=>u});var n=r(2115),s=r(9980),a=r(5792),o=r(3712),l=r(1603);let i={playSound:()=>{}};function u(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{initialProblem:t=null,playSound:r=!0,soundSystem:u=i,onProblemComplete:c=()=>{},onDebugInfoUpdate:p=null}=e,m=(0,n.useRef)({}),y=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{initialProblem:t=null,onProblemStateChange:r=()=>{},onSessionInitialized:a=()=>{}}=e||{},o=(0,n.useCallback)(function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n]},[!1]),l=(0,n.useRef)(null),i=(0,n.useRef)(!1),[u,c]=(0,n.useState)(!1),[p,m]=(0,n.useState)(!1),y=(0,n.useRef)({initTime:0,lastUpdateTime:0,errorCount:0,hasValidRomaji:!1}),[d,g]=(0,n.useState)({romaji:"",typedLength:0,currentInputLength:0,currentCharIndex:0,currentInput:"",expectedNextChar:"",currentCharRomaji:"",updated:Date.now()}),[C,f]=(0,n.useState)(0),h=(0,n.useCallback)(e=>!!e&&!!e.kanaText&&"string"==typeof e.kanaText&&!!e.displayText&&"string"==typeof e.displayText,[]),k=(0,n.useCallback)(e=>{if(!h(e))return console.warn("[useTypingCore] 無効な問題データです",e?JSON.stringify(e).substring(0,100):"undefined"),!1;y.current.initTime=Date.now(),o("問題データ初期化:",{displayText:e.displayText,kanaText:e.kanaText?e.kanaText.length>20?e.kanaText.substring(0,20)+"...":e.kanaText:"<なし>",timestamp:new Date().toLocaleTimeString()});try{var t,r,n,u;l.current&&o("既存セッションをクリーンアップします");let p=s.A.createTypingSession(e);if(!p)return console.error("[useTypingCore] セッションの作成に失敗しました"),y.current.errorCount++,!1;l.current=p,i.current=!1;let d=p.getColoringInfo(),C=d&&"string"==typeof d.romaji&&d.romaji.length>0;y.current.hasValidRomaji=C,C||console.warn("[useTypingCore] 有効なローマ字データが取得できませんでした",d),o("初期化時の表示情報:",{romaji:d&&d.romaji?d.romaji.substring(0,30)+(d.romaji.length>30?"...":""):"<なし>",currentCharIndex:null!=(t=null==d?void 0:d.currentCharIndex)?t:0,expectedNextChar:null!=(r=null==d?void 0:d.expectedNextChar)?r:"",valid:!!d&&"string"==typeof d.romaji});let h={romaji:(null==d?void 0:d.romaji)||"",typedLength:0,currentInputLength:null!=(n=null==d?void 0:d.currentInputLength)?n:0,currentCharIndex:null!=(u=null==d?void 0:d.currentCharIndex)?u:0,currentInput:(null==d?void 0:d.currentInput)||"",expectedNextChar:(null==d?void 0:d.expectedNextChar)||"",currentCharRomaji:(null==d?void 0:d.currentCharRomaji)||"",updated:Date.now()};return h.romaji||(console.warn("[useTypingCore] 表示用ローマ字が生成されませんでした"),h.romaji=""),g(h),f(0),m(!1),c(!0),a(p),!0}catch(e){return console.error("[useTypingCore] セッション初期化エラー:",e),!1}},[h]),b=(0,n.useCallback)(()=>l.current&&l.current.getCurrentExpectedKey()||"",[]),T=(0,n.useCallback)(()=>l.current?l.current.getCompletionPercentage():0,[]),S=(0,n.useCallback)(()=>{i.current||(i.current=!0,m(!0),f(100),r({type:"completed",progress:100}))},[r]);return(0,n.useEffect)(()=>{if(t){var e;u&&(null==t?void 0:t.displayText)===(null==(e=l.current)?void 0:e.displayText)||k(t)}},[t,k,u]),{isInitialized:u,isCompleted:p,displayInfo:d,progressPercentage:C,sessionRef:l,completedRef:i,initializeSession:k,markAsCompleted:S,getExpectedNextKey:b,getProgress:T,setDisplayInfo:g,setProgressPercentage:f}}({initialProblem:t,onProblemStateChange:(0,n.useCallback)(e=>{let{type:t,progress:r}=e;if("completed"===t){let e=d.recordProblemCompletion();c({problemKeyCount:e.problemKeyCount,problemElapsedMs:e.problemElapsedMs,problemKPM:e.problemKPM,updatedProblemKPMs:[],problemStats:[]})}},[c]),onSessionInitialized:e=>{d.resetStats()}}),d=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{onStatsUpdate:t=()=>{},updateInterval:r=250}=e,i=(0,n.useRef)({correctKeyCount:0,mistakeCount:0,startTime:null,currentProblemStartTime:null,problemStats:[]}),[u,c]=(0,n.useState)({correctKeyCount:0,mistakeCount:0,kpm:0,rank:"F"}),p=(0,n.useRef)(null),m=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=i.current;i.current={correctKeyCount:0,mistakeCount:0,startTime:null,currentProblemStartTime:null,previousProblemMistakeCount:e&&t.mistakeCount||0,problemStats:e&&t.problemStats||[]},c({correctKeyCount:0,mistakeCount:0,kpm:0,rank:"F"})},[]),y=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now(),t=i.current;t.startTime||(t.startTime=e,t.currentProblemStartTime=e),t.correctKeyCount+=1,p.current||(p.current=setTimeout(()=>{g(),p.current=null},r))},[]),d=(0,n.useCallback)(()=>{i.current.mistakeCount+=1,console.log("[useTypingStats] ミス数カウント更新:",i.current.mistakeCount),c(e=>({...e,mistakeCount:i.current.mistakeCount}))},[]),g=(0,n.useCallback)(async()=>{let e;i.current.workerInitialized||(a.A.initialize(),i.current.workerInitialized=!0);let r=i.current,n=r.correctKeyCount,l=r.mistakeCount,u=n+l,p=r.startTime||Date.now(),m=Date.now()-p;try{e=await a.A.calculateKPM({keyCount:n,elapsedTimeMs:m,correctKeyCount:n,totalKeyCount:u,mistakeCount:l}),(0,o.Sz)()}catch(o){console.error("[useTypingStats] KPM計算でエラー発生:",o);let t=m/6e4,r=t>0?Math.max(1,Math.floor(n/t)):0,a=s.A.getRank(r);e={kpm:r,rank:a}}let y={correctKeyCount:n,mistakeCount:l,kpm:e.kpm,rank:e.rank,accuracy:e.accuracy};return c(y),t(y),y},[t]),C=(0,n.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{timestamp:t=Date.now()}=e,r=i.current,n=r.currentProblemStartTime?t-r.currentProblemStartTime:0,o=r.correctKeyCount||0,l=r.mistakeCount||0;r.workerInitialized||(a.A.initialize(),r.workerInitialized=!0);let u=0;try{u=(await a.A.calculateKPM({keyCount:o,elapsedTimeMs:n,mistakeCount:l,correctKeyCount:o,totalKeyCount:o+l})).kpm}catch(e){console.error("[useTypingStats] 問題KPM計算エラー:",e),u=n>0?Math.floor(o/(n/6e4)):0}let c={problemKeyCount:o,problemElapsedMs:n,problemMistakeCount:l,problemKPM:u,timestamp:t},p=[...r.problemStats||[],c];r.problemStats=p;let m=0,y="F";try{let e=await a.A.calculateAverageKPM(p);m=e.kpm,y=e.rank,console.log("[useTypingStats] Worker平均KPM計算結果:",e)}catch(e){console.error("[useTypingStats] 平均KPM計算エラー:",e),m=s.A.calculateAverageKPM(p),y=s.A.getRank(m)}return g(),{problemKeyCount:c.problemKeyCount,problemElapsedMs:c.problemElapsedMs,problemKPM:c.problemKPM,problemMistakeCount:c.problemMistakeCount,correctKeyCount:r.correctKeyCount,mistakeCount:r.mistakeCount,averageKPM:m,rank:y}},[g]);return(0,n.useEffect)(()=>(a.A.initialize(),i.current.workerInitialized=!0,console.log("====================================="),console.log("【実装確認】タイピングゲーム実行環境:"),console.log("タイピング処理: メインスレッド (".concat("function"==typeof l.DS?"有効":"未定義",")")),console.log("スコア計算: ".concat((0,o.Sz)()?"WebWorker (バックグラウンドスレッド)":"メインスレッド (フォールバック)")),console.log("WebWorker利用可能性: ".concat((0,o.Sz)()?"利用可能":"利用不可")),console.log("====================================="),()=>{if(p.current&&(clearTimeout(p.current),p.current=null),i.current.workerInitialized){console.log("[useTypingStats] ScoreCalculationWorkerをクリーンアップします");try{a.A.cleanup(),i.current.workerInitialized=!1}catch(e){console.error("[useTypingStats] ScoreCalculationWorkerクリーンアップエラー:",e)}}}),[]),{statsRef:i,displayStats:u,resetStats:m,countCorrectKey:y,countMistake:d,updateDisplayStats:g,recordProblemCompletion:C}}({onStatsUpdate:e=>{if(p){let t={...m.current,stats:e};m.current=t,p(t)}}}),g=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{sessionRef:t,isCompleted:r,completedRef:s,onCorrectInput:a=()=>{},onIncorrectInput:o=()=>{},onComplete:l=()=>{},playSound:i=!0,soundSystem:u=null}=e||{},c=(0,n.useCallback)(function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n]},[!1]),p=(0,n.useRef)({totalKeyPresses:0,correctKeyPresses:0,incorrectKeyPresses:0,lastKeyTime:0,averageLatency:0}),[m,y]=(0,n.useState)(!1),d=(0,n.useRef)(null),[g,C]=(0,n.useState)("");(0,n.useRef)(!1);let f=(0,n.useCallback)(()=>{y(!0),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{y(!1),d.current=null},150)},[]),h=(0,n.useCallback)(e=>{if("string"!=typeof e)return c("無効なキー入力:",e),{success:!1,reason:"invalid_key"};if(s.current||r)return{success:!1,reason:"session_completed"};let n=t.current;if(!n)return{success:!1,reason:"session_not_found"};if(performance.now(),queueMicrotask(()=>{p.current.totalKeyPresses++,p.current.lastKeyTime=Date.now(),C(t=>t!==e?e:t)}),"function"!=typeof n.processInput)return{success:!1,reason:"invalid_session"};try{var m,y,d;let t=n.processInput(e);if(!t)return{success:!1,reason:"invalid_result"};if(t.success){if(queueMicrotask(()=>{p.current.correctKeyPresses++}),i&&u&&"function"==typeof u.playSound)try{u.playSound("success")}catch(e){queueMicrotask(()=>{try{u.playSound("success")}catch(e){console.warn("効果音再生のフォールバックでも失敗",e)}})}let r={},s=0;try{r=(null==(m=n.getColoringInfo)?void 0:m.call(n))||{},s=(null==(y=n.getCompletionPercentage)?void 0:y.call(n))||0}catch(e){console.error("[useTypingInput] 情報取得エラー:",e)}let o={romaji:r.romaji||"",typedLength:r.typedLength||0,currentInputLength:r.currentInputLength||0,currentCharIndex:r.currentCharIndex||0,currentInput:r.currentInput||"",expectedNextChar:r.expectedNextChar||"",currentCharRomaji:r.currentCharRomaji||"",updated:Date.now()};return a({key:e,displayInfo:o,progress:s,result:t}),"all_completed"===t.status&&l({result:t,displayInfo:o,progress:s}),{success:!0,displayInfo:o,progress:s}}{if(i&&u)try{u.playSound("error")}catch(e){console.warn("エラー音の再生に失敗、再試行します:",e),queueMicrotask(()=>{try{u.playSound("error")}catch(e){}})}f();let t=(null==(d=n.getCurrentExpectedKey)?void 0:d.call(n))||"";return o({key:e,expectedKey:t,timestamp:Date.now()}),{success:!1,reason:"incorrect_input"}}}catch(e){return console.error("[useTypingInput] 入力処理エラー:",e),{success:!1,reason:"processing_error",error:e}}},[t,s,r,i,u,f,a,o,l]);return(0,n.useEffect)(()=>()=>{d.current&&(clearTimeout(d.current),d.current=null)},[]),{handleInput:h,errorAnimation:m,lastPressedKey:g,setLastPressedKey:C}}({sessionRef:y.sessionRef,isCompleted:y.isCompleted,completedRef:y.completedRef,playSound:r,soundSystem:u,onComplete:t=>{y.markAsCompleted();let r=d.recordProblemCompletion(),n=(d.statsRef.current||{}).mistakeCount||0,s={problemKeyCount:r.problemKeyCount||0,problemElapsedMs:r.problemElapsedMs||0,problemKPM:r.problemKPM||0,problemMistakeCount:r.problemMistakeCount||0,displayStats:d.displayStats,totalMistakes:n};"function"==typeof e.onComplete&&e.onComplete(s)},onCorrectInput:e=>{let{key:t,displayInfo:r,progress:n}=e;y.setDisplayInfo(r),Math.abs(n-y.progressPercentage)>=5&&y.setProgressPercentage(n),d.countCorrectKey(Date.now()),p&&(m.current={...m.current,lastKey:t,displayInfo:r,progress:n},p(m.current))},onIncorrectInput:e=>{var t;let{key:r}=e;d.countMistake();let n=(null==(t=d.statsRef.current)?void 0:t.mistakeCount)||0;console.log("[useTypingGame] ミス入力を検出:",{key:r,現在のミス数:n,表示用ミス数:d.displayStats.mistakeCount}),p&&(m.current={...m.current,lastErrorKey:r,mistakeCount:n},p(m.current))}}),C=(0,n.useCallback)(e=>{var t,r;console.log("[useTypingGame] 問題を設定します:",{displayText:(null==e||null==(t=e.displayText)?void 0:t.substring(0,20))+"...",kanaText:(null==e||null==(r=e.kanaText)?void 0:r.substring(0,20))+"..."}),d.resetStats();let n=y.initializeSession(e);if(n&&y.sessionRef.current){let e=y.sessionRef.current.getColoringInfo();y.setDisplayInfo({romaji:e.romaji||"",typedLength:0,currentInputLength:e.currentInputLength||0,currentCharIndex:e.currentCharIndex||0,currentInput:e.currentInput||"",expectedNextChar:e.expectedNextChar||"",currentCharRomaji:e.currentCharRomaji||""})}return n},[y,d]),f=(0,n.useCallback)(()=>y.getExpectedNextKey(),[y]);return{isInitialized:y.isInitialized,isCompleted:y.isCompleted,displayInfo:y.displayInfo||{romaji:"",typedLength:0,currentInputLength:0,currentCharIndex:0},displayStats:d.displayStats||{},progressPercentage:y.progressPercentage||0,errorAnimation:g.errorAnimation||!1,lastPressedKey:g.lastPressedKey||"",typingSession:y.sessionRef.current,typingSessionRef:y.sessionRef,typingStats:d,statsRef:d.statsRef,handleInput:g.handleInput,setProblem:C,getNextKey:f,resetStats:d.resetStats,updateDisplayStats:d.updateDisplayStats,performanceMetrics:{get inputLatency(){return m.current.inputLatency},set inputLatency(value){m.current.inputLatency=value,p&&p(m.current)}}}}},1725:e=>{e.exports={typingText:"SimpleTypingDisplay_typingText__PuN34",typingTextContent:"SimpleTypingDisplay_typingTextContent__tdPQE",typed:"SimpleTypingDisplay_typed__TTdR0",consonant:"SimpleTypingDisplay_consonant__4jwbq",currentCharRemaining:"SimpleTypingDisplay_currentCharRemaining__Wcj49",nextChar:"SimpleTypingDisplay_nextChar__lJyRp","pulse-focus":"SimpleTypingDisplay_pulse-focus__T4VTI",remaining:"SimpleTypingDisplay_remaining__ytnjo",ellipsis:"SimpleTypingDisplay_ellipsis__SXLfh",typingCursor:"SimpleTypingDisplay_typingCursor__6GF97",cursorBlink:"SimpleTypingDisplay_cursorBlink__fg7Lj",errorShake:"SimpleTypingDisplay_errorShake___TWiZ",focusHint:"SimpleTypingDisplay_focusHint__a8RTd"}},7745:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var n=r(5155),s=r(2115),a=r(1725),o=r.n(a);let l=(0,s.memo)(e=>{let{romaji:t,typedLength:r=0,nextChar:a="",isError:l=!1,className:i="",inputMode:u="normal",currentInput:c="",currentCharRomaji:p="",visiblePortion:m={start:0,end:0}}=e,y=(0,s.useRef)(null),d=(0,s.useRef)(null),g=(0,s.useRef)(null),C="string"==typeof t?t:"",f=Number.isInteger(r)&&r>=0?r:0,h=C.substring(0,f)||"",k="string"==typeof c?c:"",b="string"==typeof a?a:"",T="",S=!m||0===m.start&&0===m.end||!Number.isInteger(m.start)||!Number.isInteger(m.end),x=m&&"object"==typeof m&&Number.isInteger(m.start)&&Number.isInteger(m.end)&&m.start>=0&&m.end>m.start&&m.end<=C.length,I=!x||S?C:C.substring(m.start,m.end),_=Math.max(0,r-(S?0:(null==m?void 0:m.start)||0));if("consonant"===u&&c){k=c,b=p&&p.length>c.length?p.charAt(c.length):"a";let e=r+p.length;if(S)T=C.substring(e)||"";else{let t=Math.max(0,e-((null==m?void 0:m.start)||0));T=I.substring(t)||""}}else if(b=a,S){let e=r+ +!!a;T=C.substring(e)||""}else{let e=_+ +!!a;T=I.substring(e)||""}(0,s.useEffect)(()=>{if(d.current&&y.current)try{let e=d.current,t=y.current,r=e.getBoundingClientRect(),n=t.getBoundingClientRect();if(!(r.top>=n.top&&r.bottom<=n.bottom)){let r=e.offsetTop-t.clientHeight/2+e.offsetHeight/2;t.scrollTo({top:r,behavior:"smooth"})}}catch(e){console.error("フォーカス文字のスクロール処理エラー:",e)}},[r,a,b,u]),(0,s.useEffect)(()=>{y.current&&g.current&&r>0&&(y.current.scrollLeft=0)},[m,r]);let K="".concat(o().typingText," ").concat(i||""," ").concat(l?o().errorShake:"");if(!C)return(0,n.jsx)("div",{className:K,ref:y,children:(0,n.jsx)("span",{className:o().typingCursor})});let v=!S&&x&&m.start>0?"...":"",R=!S&&x&&m.end<C.length?"...":"";return(0,n.jsx)("div",{className:K,ref:y,children:(0,n.jsxs)("div",{className:o().typingTextContent,ref:g,children:[v&&(0,n.jsx)("span",{className:o().ellipsis,children:v}),h&&(0,n.jsx)("span",{className:o().typed,children:S?h:I.substring(0,Math.min(_,I.length))}),"consonant"===u&&k&&(0,n.jsx)("span",{className:o().consonant,children:k}),b&&(0,n.jsx)("span",{className:o().nextChar,ref:d,children:b}),"        ","consonant"===u&&"string"==typeof p&&p.length>((null==c?void 0:c.length)||0)+1&&(0,n.jsx)("span",{className:o().currentCharRemaining,children:p.substring(((null==c?void 0:c.length)||0)+1)}),T&&(0,n.jsx)("span",{className:o().remaining,children:T}),R&&(0,n.jsx)("span",{className:o().ellipsis,children:R}),(0,n.jsx)("span",{className:o().typingCursor})]})})});l.displayName="SimpleTypingDisplay";let i=l}}]);