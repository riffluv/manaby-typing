"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[117],{9117:(t,e,s)=>{s.r(e),s.d(e,{TypingModelMCP:()=>o,default:()=>p,getTypingModelInstance:()=>c});var i=s(9980);let a={INPUT_PROCESSED:"typing:inputProcessed",STATE_UPDATED:"typing:stateUpdated",DISPLAY_UPDATED:"typing:displayUpdated",PROBLEM_LOADED:"typing:problemLoaded",PROBLEM_COMPLETED:"typing:problemCompleted",ERROR:"typing:error"},r={INITIALIZE:"typing:initialize",RESET:"typing:reset",PROCESS_INPUT:"typing:processInput",GET_STATE:"typing:getState",GET_DISPLAY_INFO:"typing:getDisplayInfo",LOAD_PROBLEM:"typing:loadProblem",COMPLETE_PROBLEM:"typing:completeProblem",GET_STATS:"typing:getStats",SUBMIT_SCORE:"typing:submitScore"},n={display:{romaji:"",typedLength:0,nextChar:"",currentInput:"",currentCharRomaji:"",inputMode:"normal",isError:!1,isCompleted:!1},internal:{currentCharIndex:0,typedRomaji:"",patterns:[],displayIndices:[],patternLengths:[],expectedChars:[],completed:!1},stats:{correctKeyCount:0,mistakeCount:0,startTime:null,currentProblemStartTime:null,elapsedTimeSeconds:0,kpm:0,accuracy:100,rank:"F",problemStats:[]},problem:{displayText:"",kanaText:"",originalText:""}};function l(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"UNKNOWN_ERROR";return{message:t,code:e,timestamp:Date.now()}}class o{_createInitialState(){return{display:{...n.display},internal:{...n.internal},stats:{...n.stats},problem:{...n.problem}}}_registerMCPHandlers(){if(window._mcp){var t,e,s,i,a,n,l,o,h,c,p,d,_,u,m,T,y,I;null==(t=(e=window._mcp).registerHandler)||t.call(e,r.INITIALIZE,this._handleInitialize.bind(this)),null==(s=(i=window._mcp).registerHandler)||s.call(i,r.RESET,this._handleReset.bind(this)),null==(a=(n=window._mcp).registerHandler)||a.call(n,r.PROCESS_INPUT,this._handleProcessInput.bind(this)),null==(l=(o=window._mcp).registerHandler)||l.call(o,r.GET_STATE,this._handleGetState.bind(this)),null==(h=(c=window._mcp).registerHandler)||h.call(c,r.GET_DISPLAY_INFO,this._handleGetDisplayInfo.bind(this)),null==(p=(d=window._mcp).registerHandler)||p.call(d,r.LOAD_PROBLEM,this._handleLoadProblem.bind(this)),null==(_=(u=window._mcp).registerHandler)||_.call(u,r.COMPLETE_PROBLEM,this._handleCompleteProblem.bind(this)),null==(m=(T=window._mcp).registerHandler)||m.call(T,r.GET_STATS,this._handleGetStats.bind(this)),null==(y=(I=window._mcp).registerHandler)||y.call(I,r.SUBMIT_SCORE,this._handleSubmitScore.bind(this)),console.log("[TypingModelMCP] MCPハンドラ登録完了")}else console.warn("[TypingModelMCP] MCP接続がないため、ハンドラを登録できませんでした")}_handleInitialize(t){try{let{problem:e}=t||{};return this._reset(),e&&this._loadProblem(e),this._emitEvent(a.STATE_UPDATED,{state:this.getState(),action:"initialize"}),{success:!0,state:this.getState()}}catch(t){return console.error("[TypingModelMCP] 初期化エラー:",t),this._emitEvent(a.ERROR,l("初期化エラー: ".concat(t.message),"INIT_ERROR")),{success:!1,error:t.message}}}_handleReset(){try{return this._reset(),this._emitEvent(a.STATE_UPDATED,{state:this.getState(),action:"reset"}),{success:!0,state:this.getState()}}catch(t){return console.error("[TypingModelMCP] リセットエラー:",t),this._emitEvent(a.ERROR,l("リセットエラー: ".concat(t.message),"RESET_ERROR")),{success:!1,error:t.message}}}_handleProcessInput(t){try{let{key:e}=t||{};if(!e)throw Error("入力キーが指定されていません");if(!this._state.internal.session)throw Error("タイピングセッションが初期化されていません");let s=this._processInput(e);return this._emitEvent(a.INPUT_PROCESSED,{key:e,result:s,state:this.getDisplayInfo()}),{success:!0,result:s,state:this.getDisplayInfo()}}catch(t){return console.error("[TypingModelMCP] 入力処理エラー:",t),this._emitEvent(a.ERROR,l("入力処理エラー: ".concat(t.message),"INPUT_ERROR")),{success:!1,error:t.message}}}_handleGetState(){return{state:this.getState()}}_handleGetDisplayInfo(){return{displayInfo:this.getDisplayInfo()}}_handleLoadProblem(t){try{let{problem:e}=t||{};if(!e)throw Error("問題データが指定されていません");return this._loadProblem(e),this._emitEvent(a.PROBLEM_LOADED,{problem:e,state:this.getState()}),{success:!0,state:this.getState()}}catch(t){return console.error("[TypingModelMCP] 問題読み込みエラー:",t),this._emitEvent(a.ERROR,l("問題読み込みエラー: ".concat(t.message),"PROBLEM_LOAD_ERROR")),{success:!1,error:t.message}}}_handleCompleteProblem(){try{let t=this._completeProblem();return this._emitEvent(a.PROBLEM_COMPLETED,{stats:this._state.stats,result:t}),{success:!0,stats:this._state.stats,result:t}}catch(t){return console.error("[TypingModelMCP] 問題完了処理エラー:",t),this._emitEvent(a.ERROR,l("問題完了処理エラー: ".concat(t.message),"COMPLETE_ERROR")),{success:!1,error:t.message}}}_handleGetStats(){return{stats:this._state.stats}}_handleSubmitScore(t){try{let{username:e,endpoint:s}=t||{},a=i.A.submitRanking({username:e||"Anonymous",score:this._state.stats.correctKeyCount||0,kpm:this._state.stats.kpm||0,accuracy:this._state.stats.accuracy||0,problemCount:(this._state.stats.problemStats||[]).length,endpoint:s});return{success:!0,result:a}}catch(t){return console.error("[TypingModelMCP] スコア送信エラー:",t),this._emitEvent(a.ERROR,l("スコア送信エラー: ".concat(t.message),"SUBMIT_SCORE_ERROR")),{success:!1,error:t.message}}}_reset(){this._state=this._createInitialState(),this._errorAnimationTimerId&&(clearTimeout(this._errorAnimationTimerId),this._errorAnimationTimerId=null),this._statsUpdateTimerId&&(clearTimeout(this._statsUpdateTimerId),this._statsUpdateTimerId=null),console.log("[TypingModelMCP] 状態をリセットしました")}_loadProblem(t){if(!t)throw Error("有効な問題データが指定されていません");try{let e=i.A.createTypingSession(t);if(!e)throw Error("タイピングセッションの作成に失敗しました");this._state.problem={displayText:t.displayText||"",kanaText:t.kanaText||"",originalText:t.displayText||""},this._state.internal.session=e,this._state.internal.currentCharIndex=0,this._state.internal.typedRomaji="",this._state.internal.patterns=e.patterns||[],this._state.internal.displayIndices=e.displayIndices||[],this._state.internal.patternLengths=e.patternLengths||[],this._state.internal.expectedChars=e.expectedChars||[],this._state.internal.completed=!1,this._updateDisplayInfo(),console.log("[TypingModelMCP] 問題を読み込みました:",t.displayText)}catch(t){throw console.error("[TypingModelMCP] 問題読み込みエラー:",t),t}}_processInput(t){let e=this._state.internal.session;if(!e)throw Error("タイピングセッションが初期化されていません");if(this._state.internal.completed)return{success:!1,status:"already_completed"};let s=performance.now&&performance.now(),r=i.A.convertFullWidthToHalfWidth(t.toLowerCase()),n=e.processInput(r);if(n.success){let t=Date.now();this._state.stats.startTime||(this._state.stats.startTime=t),this._state.stats.currentProblemStartTime||(this._state.stats.currentProblemStartTime=t),this._state.stats.correctKeyCount+=1,"all_completed"===n.status&&(this._state.internal.completed=!0,this._state.display.isCompleted=!0),this._fastUpdateDisplayInfo(),this._updateStatsThrottled()}else this._state.stats.mistakeCount+=1,this._state.display.isError=!0,this._errorAnimationTimerId&&clearTimeout(this._errorAnimationTimerId),this._errorAnimationTimerId=setTimeout(()=>{this._state.display.isError=!1,this._errorAnimationTimerId=null,this._emitEvent(a.DISPLAY_UPDATED,{displayInfo:this.getDisplayInfo()})},200);return performance.now&&performance.now(),n}processLocalInput(t){let e=this._state.internal.session;if(!e)return{success:!1,status:"no_session"};if(this._state.internal.completed)return{success:!1,status:"already_completed"};performance.now&&performance.now();let s=t.toLowerCase().replace(/[Ａ-Ｚａ-ｚ０-９]/g,t=>String.fromCharCode(t.charCodeAt(0)-65248)),i="".concat(this._state.internal.currentCharIndex,":").concat(this._state.internal.currentInput,":").concat(s);if(this._inputResultCache&&this._inputResultCache.has(i)){let t=this._inputResultCache.get(i);if(t.stateUpdates){let e=t.stateUpdates;if(void 0!==e.completed&&(this._state.internal.completed=e.completed,this._state.display.isCompleted=e.completed),void 0!==e.currentCharIndex&&(this._state.internal.currentCharIndex=e.currentCharIndex),void 0!==e.typedRomaji&&(this._state.internal.typedRomaji=e.typedRomaji),void 0!==e.currentInput&&(this._state.internal.currentInput=e.currentInput),void 0!==e.typedLength&&(this._state.display.typedLength=e.typedLength),t.success&&e.statsIncrement){let t=Date.now();this._state.stats.startTime||(this._state.stats.startTime=t),this._state.stats.currentProblemStartTime||(this._state.stats.currentProblemStartTime=t),this._state.stats.correctKeyCount+=e.statsIncrement}}return t.success?t.displayUpdates?Object.assign(this._state.display,t.displayUpdates):this._fastUpdateDisplayInfoMinimal():t.success||(this._state.display.isError=!0,this._errorAnimationTimerId&&clearTimeout(this._errorAnimationTimerId),this._errorAnimationTimerId=setTimeout(()=>{this._state.display.isError=!1,this._errorAnimationTimerId=null},200)),t.result}let a=e.processInput(s);if(a.success){let t=Date.now();if(this._state.stats.startTime||(this._state.stats.startTime=t),this._state.stats.currentProblemStartTime||(this._state.stats.currentProblemStartTime=t),this._state.stats.correctKeyCount+=1,"all_completed"===a.status&&(this._state.internal.completed=!0,this._state.display.isCompleted=!0),this._fastUpdateDisplayInfoMinimal(),this._updateStatsThrottled(2e3),this._inputResultCache||(this._inputResultCache=new Map),this._inputResultCache.size>1e3){let t=Array.from(this._inputResultCache.keys()),e=Math.floor(.2*t.length);t.slice(0,e).forEach(t=>{this._inputResultCache.delete(t)})}this._inputResultCache.set(i,{result:a,success:!0,stateUpdates:{currentCharIndex:this._state.internal.currentCharIndex,typedRomaji:this._state.internal.typedRomaji,currentInput:this._state.internal.currentInput,completed:this._state.internal.completed,typedLength:this._state.display.typedLength,statsIncrement:1},displayUpdates:{typedLength:this._state.display.typedLength,nextChar:this._state.display.nextChar,currentInput:this._state.display.currentInput,currentCharRomaji:this._state.display.currentCharRomaji,inputMode:this._state.display.inputMode}})}else this._state.stats.mistakeCount+=1,this._state.display.isError=!0,this._errorAnimationTimerId&&clearTimeout(this._errorAnimationTimerId),this._errorAnimationTimerId=setTimeout(()=>{this._state.display.isError=!1,this._errorAnimationTimerId=null},200),this._inputResultCache||(this._inputResultCache=new Map),this._inputResultCache.set(i,{result:a,success:!1,stateUpdates:null});return performance.now,a}_fastUpdateDisplayInfoMinimal(){let t=this._state.internal.session;if(t)try{let e=t.getColoringInfo();if(this._state.display.typedLength=e.typedLength||0,this._state.display.nextChar=e.expectedNextChar||"",this._state.display.currentInput=e.currentInput||"",e.currentInput){let t=e.currentInput,s=e.currentCharRomaji||"";this._state.display.inputMode=s&&t&&s.length>t.length?"consonant":"normal",this._state.display.currentCharRomaji=s}}catch(t){console.error("[TypingModelMCP] 表示情報更新エラー:",t)}}_updateStatsThrottled(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,e=Date.now(),s=this._lastStatsUpdateTime||0;!this._statsUpdateTimerId&&e-s>t&&(this._statsUpdateTimerId=setTimeout(()=>{this._calculateStats(),this._lastStatsUpdateTime=Date.now(),this._statsUpdateTimerId=null},200))}constructor(){this._state=this._createInitialState(),this._registerMCPHandlers(),this._listeners=new Map}}let h=null;function c(){return h||(h=new o),h}let p={TypingModelMCP:o,getTypingModelInstance:c}}}]);