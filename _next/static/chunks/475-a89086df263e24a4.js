(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[475],{1427:(e,t,r)=>{"use strict";r.d(t,{z:()=>u});var n=r(2115),s=r(9980),a=r(5792),o=r(3712);r(1603);let l={playSound:()=>{}};function u(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{initialProblem:t=null,playSound:r=!0,soundSystem:u=l,onProblemComplete:i=()=>{},onDebugInfoUpdate:c=null}=e,p=(0,n.useRef)({}),m=(0,n.useCallback)(e=>{let{type:t,progress:r}=e;if("completed"===t){let e=y.recordProblemCompletion();i({problemKeyCount:e.problemKeyCount,problemElapsedMs:e.problemElapsedMs,problemKPM:e.problemKPM,updatedProblemKPMs:[],problemStats:[]})}},[i]),d=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{initialProblem:t=null,onProblemStateChange:r=()=>{},onSessionInitialized:a=()=>{}}=e||{},o=(0,n.useCallback)(function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n]},[!1]),l=(0,n.useRef)(null),u=(0,n.useRef)(!1),[i,c]=(0,n.useState)(!1),[p,m]=(0,n.useState)(!1),d=(0,n.useRef)({initTime:0,lastUpdateTime:0,errorCount:0,hasValidRomaji:!1}),[y,g]=(0,n.useState)({romaji:"",typedLength:0,currentInputLength:0,currentCharIndex:0,currentInput:"",expectedNextChar:"",currentCharRomaji:"",updated:Date.now()}),[C,f]=(0,n.useState)(0),h=(0,n.useCallback)(e=>!!e&&!!e.kanaText&&"string"==typeof e.kanaText&&!!e.displayText&&"string"==typeof e.displayText,[]),b=(0,n.useCallback)(e=>{if(!h(e))return console.warn("[useTypingCore] 無効な問題データです",e?JSON.stringify(e).substring(0,100):"undefined"),!1;d.current.initTime=Date.now(),o("問題データ初期化:",{displayText:e.displayText,kanaText:e.kanaText?e.kanaText.length>20?e.kanaText.substring(0,20)+"...":e.kanaText:"<なし>",timestamp:new Date().toLocaleTimeString()});try{var t,r,n,i;l.current&&o("既存セッションをクリーンアップします");let p=s.A.createTypingSession(e);if(!p)return console.error("[useTypingCore] セッションの作成に失敗しました"),d.current.errorCount++,!1;l.current=p,u.current=!1;let y=p.getColoringInfo(),C=y&&"string"==typeof y.romaji&&y.romaji.length>0;d.current.hasValidRomaji=C,C||console.warn("[useTypingCore] 有効なローマ字データが取得できませんでした",y),o("初期化時の表示情報:",{romaji:y&&y.romaji?y.romaji.substring(0,30)+(y.romaji.length>30?"...":""):"<なし>",currentCharIndex:null!=(t=null==y?void 0:y.currentCharIndex)?t:0,expectedNextChar:null!=(r=null==y?void 0:y.expectedNextChar)?r:"",valid:!!y&&"string"==typeof y.romaji});let h={romaji:(null==y?void 0:y.romaji)||"",typedLength:0,currentInputLength:null!=(n=null==y?void 0:y.currentInputLength)?n:0,currentCharIndex:null!=(i=null==y?void 0:y.currentCharIndex)?i:0,currentInput:(null==y?void 0:y.currentInput)||"",expectedNextChar:(null==y?void 0:y.expectedNextChar)||"",currentCharRomaji:(null==y?void 0:y.currentCharRomaji)||"",updated:Date.now()};return h.romaji||(console.warn("[useTypingCore] 表示用ローマ字が生成されませんでした"),h.romaji=""),g(h),f(0),m(!1),c(!0),a(p),!0}catch(e){return console.error("[useTypingCore] セッション初期化エラー:",e),!1}},[h]),k=(0,n.useCallback)(e=>{g(e)},[]),x=(0,n.useCallback)(e=>{try{m(e),!0===e&&(u.current=!0)}catch(e){console.error("[useTypingCore] 完了状態の更新でエラーが発生しました:",e)}},[!1]),T=(0,n.useCallback)(()=>l.current&&l.current.getCurrentExpectedKey()||"",[]),S=(0,n.useCallback)(()=>l.current?l.current.getCompletionPercentage():0,[]),v=(0,n.useCallback)(()=>{u.current||(u.current=!0,m(!0),f(100),r({type:"completed",progress:100}))},[r]);return(0,n.useEffect)(()=>{if(t){var e;i&&(null==t?void 0:t.displayText)===(null==(e=l.current)?void 0:e.displayText)||b(t)}},[t,b,i]),{isInitialized:i,isCompleted:p,displayInfo:y,progressPercentage:C,sessionRef:l,completedRef:u,initializeSession:b,markAsCompleted:v,getExpectedNextKey:T,getProgress:S,setDisplayData:k,setCompleted:x,setDisplayInfo:g,setProgressPercentage:f}}({initialProblem:t,onProblemStateChange:m,onSessionInitialized:e=>{y.resetStats()}}),y=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{onStatsUpdate:t=()=>{},updateInterval:r=250}=e,l=(0,n.useRef)({correctKeyCount:0,mistakeCount:0,startTime:null,currentProblemStartTime:null,problemStats:[]}),[u,i]=(0,n.useState)({correctKeyCount:0,mistakeCount:0,kpm:0,rank:"F"}),c=(0,n.useRef)(null),p=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=l.current;l.current={correctKeyCount:0,mistakeCount:0,startTime:null,currentProblemStartTime:null,previousProblemMistakeCount:e&&t.mistakeCount||0,problemStats:e&&t.problemStats||[]},i({correctKeyCount:0,mistakeCount:0,kpm:0,rank:"F"})},[]),m=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now(),t=l.current;t.startTime||(t.startTime=e,t.currentProblemStartTime=e),t.correctKeyCount+=1,c.current||(c.current=setTimeout(()=>{y(),c.current=null},r))},[]),d=(0,n.useCallback)(()=>{l.current.mistakeCount+=1,i(e=>({...e,mistakeCount:l.current.mistakeCount}))},[]),y=(0,n.useCallback)(async()=>{let e;l.current.workerInitialized||(a.A.initialize(),l.current.workerInitialized=!0);let r=l.current,n=r.correctKeyCount,u=r.mistakeCount,c=n+u,p=r.startTime||Date.now(),m=Date.now()-p;try{e=await a.A.calculateKPM({keyCount:n,elapsedTimeMs:m,correctKeyCount:n,totalKeyCount:c,mistakeCount:u}),(0,o.Sz)()}catch(o){console.error("[useTypingStats] KPM計算でエラー発生:",o);let t=m/6e4,r=t>0?Math.max(1,Math.floor(n/t)):0,a=s.A.getRank(r);e={kpm:r,rank:a}}let d={correctKeyCount:n,mistakeCount:u,kpm:e.kpm,rank:e.rank,accuracy:e.accuracy};return i(d),t(d),d},[t]),g=(0,n.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{timestamp:t=Date.now()}=e,r=l.current,n=r.currentProblemStartTime?t-r.currentProblemStartTime:0,o=r.correctKeyCount||0,u=r.mistakeCount||0;r.workerInitialized||(a.A.initialize(),r.workerInitialized=!0);let i=0;try{i=(await a.A.calculateKPM({keyCount:o,elapsedTimeMs:n,mistakeCount:u,correctKeyCount:o,totalKeyCount:o+u})).kpm}catch(e){console.error("[useTypingStats] 問題KPM計算エラー:",e),i=n>0?Math.floor(o/(n/6e4)):0}let c={problemKeyCount:o,problemElapsedMs:n,problemMistakeCount:u,problemKPM:i,timestamp:t},p=[...r.problemStats||[],c];r.problemStats=p;let m=0,d="F";try{let e=await a.A.calculateAverageKPM(p);m=e.kpm,d=e.rank}catch(e){console.error("[useTypingStats] 平均KPM計算エラー:",e),m=s.A.calculateAverageKPM(p),d=s.A.getRank(m)}return y(),{problemKeyCount:c.problemKeyCount,problemElapsedMs:c.problemElapsedMs,problemKPM:c.problemKPM,problemMistakeCount:c.problemMistakeCount,correctKeyCount:r.correctKeyCount,mistakeCount:r.mistakeCount,averageKPM:m,rank:d}},[y]);return(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;console.log("[useTypingStats] ".concat(e,"文字スキップしました"))},[]),(0,n.useEffect)(()=>(a.A.initialize(),l.current.workerInitialized=!0,()=>{if(c.current&&(clearTimeout(c.current),c.current=null),l.current.workerInitialized)try{a.A.cleanup(),l.current.workerInitialized=!1}catch(e){console.error("[useTypingStats] ScoreCalculationWorkerクリーンアップエラー:",e)}}),[]),{statsRef:l,displayStats:u,resetStats:p,countCorrectKey:m,countMistake:d,updateDisplayStats:y,recordProblemCompletion:g,recordMistake:(0,n.useCallback)(()=>d(),[d]),getLatestStats:(0,n.useCallback)(()=>({...u,correctKeyCount:l.current.correctKeyCount,mistakeCount:l.current.mistakeCount}),[u]),recordSkip:(0,n.useCallback)(function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]},[]),recordCorrectKey:(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now();return m(e)},[m])}}({onStatsUpdate:e=>{if(c){let t={...p.current,stats:e};p.current=t,c(t)}}}),g=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{sessionRef:t,isCompleted:r,completedRef:s,onCorrectInput:a=()=>{},onIncorrectInput:o=()=>{},onComplete:l=()=>{},onLineEnd:u=()=>{},playSound:i=!0,soundSystem:c=null,updateInterval:p=16}=e||{},m=(0,n.useCallback)(function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n]},[!1]),d=(0,n.useRef)({totalKeyPresses:0,correctKeyPresses:0,incorrectKeyPresses:0,lastKeyTime:0,averageLatency:0}),[y,g]=(0,n.useState)({points:0,combo:0,maxCombo:0}),[C,f]=(0,n.useState)(!1),h=(0,n.useRef)(null),[b,k]=(0,n.useState)(""),x=(0,n.useRef)(null);(0,n.useRef)(!1);let T=(0,n.useCallback)(()=>{f(!0),h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{f(!1),h.current=null},150)},[]),S=(0,n.useCallback)(()=>{let e=null==t?void 0:t.current;if(e&&(null==s||!s.current)&&!r&&"function"==typeof e.update)try{let t=performance.now(),[r,s]=e.update(t);if(r){var n,a,o,i,c,p;m("行の更新:",{leftover:s}),u({timestamp:t,leftover:s,completed:(null==(n=e.isCompleted)?void 0:n.call(e))||!1,combo:(null==(a=e.getCombo)?void 0:a.call(e))||0,maxCombo:(null==(o=e.getMaxCombo)?void 0:o.call(e))||0}),(null==(i=e.isCompleted)?void 0:i.call(e))&&l({result:{status:"time_completed"},progress:100,combo:(null==(c=e.getCombo)?void 0:c.call(e))||0,maxCombo:(null==(p=e.getMaxCombo)?void 0:p.call(e))||0}),I()}}catch(e){console.error("[useTypingInput] 更新処理エラー:",e)}},[t,s,r,u,l]),v=(0,n.useCallback)(()=>{x.current&&clearInterval(x.current),x.current=setInterval(()=>{S()},p),S()},[S,p]),I=(0,n.useCallback)(()=>{var e,r;let n=null==t?void 0:t.current;if(!n)return;let s=(null==(e=n.getCombo)?void 0:e.call(n))||0,a=(null==(r=n.getMaxCombo)?void 0:r.call(n))||0;g(e=>e.combo===s&&e.maxCombo===a?e:{...e,combo:s,maxCombo:a})},[t]),_=(0,n.useCallback)(e=>{if("string"!=typeof e)return m("無効なキー入力:",e),{success:!1,reason:"invalid_key"};if(s.current||r)return{success:!1,reason:"session_completed"};let n=t.current;if(!n)return{success:!1,reason:"session_not_found"};performance.now(),queueMicrotask(()=>{d.current.totalKeyPresses++,d.current.lastKeyTime=Date.now(),k(t=>t!==e?e:t)});try{var u,p,y,g,C,f,h;let t;if(Date.now(),"function"==typeof n.accept){let r=n.accept(e);1===r?(t={success:!0,status:"input_accepted"},(null==(u=n.isCompleted)?void 0:u.call(n))&&(t.status="all_completed")):t=-1===r?{success:!1,status:"wrong_input"}:{success:!1,status:"invalid_input"}}else{if("function"!=typeof n.processInput)return{success:!1,reason:"invalid_session"};t=n.processInput(e)}if(t.success){if(queueMicrotask(()=>{d.current.correctKeyPresses++}),i&&c&&"function"==typeof c.playSound)try{c.playSound("success")}catch(e){queueMicrotask(()=>{try{c.playSound("success")}catch(e){console.warn("効果音再生のフォールバックでも失敗",e)}})}let r={},s=0;try{r=(null==(y=n.getColoringInfo)?void 0:y.call(n))||{},s=(null==(g=n.getCompletionPercentage)?void 0:g.call(n))||0}catch(e){console.error("[useTypingInput] 情報取得エラー:",e)}let o={romaji:r.romaji||"",typedLength:r.typedLength||0,currentInputLength:r.currentInputLength||0,currentCharIndex:r.currentCharIndex||0,currentInput:r.currentInput||"",expectedNextChar:r.expectedNextChar||"",currentCharRomaji:r.currentCharRomaji||"",updated:Date.now()};return I(),a({key:e,displayInfo:o,progress:s,result:t}),("all_completed"===t.status||(null==(p=n.isCompleted)?void 0:p.call(n))===!0)&&l({result:{status:"all_completed"},displayInfo:o,progress:100,combo:(null==(C=n.getCombo)?void 0:C.call(n))||0,maxCombo:(null==(f=n.getMaxCombo)?void 0:f.call(n))||0}),{success:!0,displayInfo:o,progress:s}}{if(i&&c)try{c.playSound("error")}catch(e){console.warn("エラー音の再生に失敗、再試行します:",e),queueMicrotask(()=>{try{c.playSound("error")}catch(e){}})}T(),I();let t=(null==(h=n.getCurrentExpectedKey)?void 0:h.call(n))||"";return o({key:e,expectedKey:t,timestamp:Date.now()}),{success:!1,reason:"incorrect_input"}}}catch(e){return console.error("[useTypingInput] 入力処理エラー:",e),{success:!1,reason:"processing_error",error:e}}},[t,s,r,i,c,T,a,o,l,I]);return(0,n.useEffect)(()=>(v(),()=>{h.current&&(clearTimeout(h.current),h.current=null),x.current&&(clearInterval(x.current),x.current=null)}),[v]),{handleInput:_,errorAnimation:C,lastPressedKey:b,setLastPressedKey:k,score:y,updateSession:S}}({sessionRef:d.sessionRef,isCompleted:d.isCompleted,completedRef:d.completedRef,playSound:r,soundSystem:u,onCorrectInput:e=>{let{key:t,displayInfo:r,progress:n}=e;Math.abs(n-d.progressPercentage)>5&&d.setProgressPercentage(n),d.setDisplayData(r),y.recordCorrectKey()},onIncorrectInput:()=>{y.recordMistake()},onComplete:e=>{let{result:t,displayInfo:r,progress:n,combo:s,maxCombo:a}=e;try{d&&"function"==typeof d.setCompleted?(d.setCompleted(!0),d.completedRef&&(d.completedRef.current=!0)):console.warn("[useTypingGame] typingCore.setCompletedが未定義です"),d&&"function"==typeof d.setProgressPercentage&&d.setProgressPercentage(100),d&&"function"==typeof d.setDisplayData&&d.setDisplayData(r)}catch(e){console.error("[useTypingGame] 完了処理中にエラーが発生しました:",e)}m({type:"completed",progress:100,combo:s,maxCombo:a})},onLineEnd:e=>{let{leftover:t,completed:r,combo:n,maxCombo:s}=e;t>0&&y.recordSkip(t),r&&m({type:"completed",progress:100,combo:n,maxCombo:s})}}),C=(0,n.useCallback)(e=>{d.sessionRef.current&&!d.isCompleted&&g.updateSession&&g.updateSession(e)},[d.sessionRef,d.isCompleted,g]),f=(0,n.useCallback)(()=>{try{var e,t,r;let n=null==d||null==(e=d.sessionRef)?void 0:e.current;if(!n)return{combo:0,maxCombo:0,score:0,rank:"F"};let s={combo:(null==(t=n.getCombo)?void 0:t.call(n))||0,maxCombo:(null==(r=n.getMaxCombo)?void 0:r.call(n))||0};if(!y||"function"!=typeof y.getLatestStats)return{...s,score:0,rank:"F"};{let e=y.getLatestStats()||{};return{...s,...e,score:e.kpm?Math.floor(e.kpm*(s.maxCombo||1)):0,rank:e.rank||"F"}}}catch(e){return console.error("[useTypingGame] スコア情報の取得中にエラーが発生しました:",e),{combo:0,maxCombo:0,score:0,rank:"F"}}},[null==d?void 0:d.sessionRef,y]);(0,n.useEffect)(()=>{if(!d.sessionRef.current)return;let e=null,t=r=>{C(r),e=requestAnimationFrame(t)};return e=requestAnimationFrame(t),()=>{null!==e&&cancelAnimationFrame(e)}},[d.sessionRef,C]),(0,n.useEffect)(()=>{if(!c)return;let e={session:d.sessionRef.current?{completed:d.isCompleted,progress:d.progressPercentage,displayData:d.displayData}:null,stats:y.getLatestStats(),input:{lastKey:g.lastPressedKey,errorState:g.errorAnimation},score:f()};p.current=e,c(e)},[d.isCompleted,d.progressPercentage,d.displayData,g.lastPressedKey,g.errorAnimation,c,y,f]);let h=(0,n.useCallback)(e=>{y.resetStats();let t=d.initializeSession(e);if(t&&d.sessionRef.current){let e=d.sessionRef.current.getColoringInfo();d.setDisplayInfo({romaji:e.romaji||"",typedLength:0,currentInputLength:e.currentInputLength||0,currentCharIndex:e.currentCharIndex||0,currentInput:e.currentInput||"",expectedNextChar:e.expectedNextChar||"",currentCharRomaji:e.currentCharRomaji||""})}return t},[d,y]),b=(0,n.useCallback)(()=>d.getExpectedNextKey(),[d]);return{isInitialized:d.isInitialized,isCompleted:d.isCompleted,displayInfo:d.displayInfo||{romaji:"",typedLength:0,currentInputLength:0,currentCharIndex:0},displayStats:y.displayStats||{},progressPercentage:d.progressPercentage||0,errorAnimation:g.errorAnimation||!1,lastPressedKey:g.lastPressedKey||"",typingSession:d.sessionRef.current,typingSessionRef:d.sessionRef,typingStats:y,statsRef:y.statsRef,handleInput:g.handleInput,setProblem:h,getNextKey:b,resetStats:y.resetStats,updateDisplayStats:y.updateDisplayStats,performanceMetrics:{get inputLatency(){return p.current.inputLatency},set inputLatency(value){p.current.inputLatency=value,c&&c(p.current)}}}}},1725:e=>{e.exports={typingText:"SimpleTypingDisplay_typingText__PuN34",typingTextContent:"SimpleTypingDisplay_typingTextContent__tdPQE",typed:"SimpleTypingDisplay_typed__TTdR0",consonant:"SimpleTypingDisplay_consonant__4jwbq",currentCharRemaining:"SimpleTypingDisplay_currentCharRemaining__Wcj49",nextChar:"SimpleTypingDisplay_nextChar__lJyRp","pulse-focus":"SimpleTypingDisplay_pulse-focus__T4VTI",remaining:"SimpleTypingDisplay_remaining__ytnjo",ellipsis:"SimpleTypingDisplay_ellipsis__SXLfh",typingCursor:"SimpleTypingDisplay_typingCursor__6GF97",cursorBlink:"SimpleTypingDisplay_cursorBlink__fg7Lj",errorShake:"SimpleTypingDisplay_errorShake___TWiZ",focusHint:"SimpleTypingDisplay_focusHint__a8RTd"}},7745:(e,t,r)=>{"use strict";r.d(t,{A:()=>u});var n=r(5155),s=r(2115),a=r(1725),o=r.n(a);let l=(0,s.memo)(e=>{let{romaji:t,typedLength:r=0,nextChar:a="",isError:l=!1,className:u="",inputMode:i="normal",currentInput:c="",currentCharRomaji:p="",visiblePortion:m={start:0,end:0}}=e,d=(0,s.useRef)(null),y=(0,s.useRef)(null),g=(0,s.useRef)(null),C="string"==typeof t?t:"",f=Number.isInteger(r)&&r>=0?r:0,h=C.substring(0,f)||"",b="string"==typeof c?c:"",k="string"==typeof a?a:"",x="",T=!m||0===m.start&&0===m.end||!Number.isInteger(m.start)||!Number.isInteger(m.end),S=m&&"object"==typeof m&&Number.isInteger(m.start)&&Number.isInteger(m.end)&&m.start>=0&&m.end>m.start&&m.end<=C.length,v=!S||T?C:C.substring(m.start,m.end),I=Math.max(0,r-(T?0:(null==m?void 0:m.start)||0));if("consonant"===i&&c){b=c,k=p&&p.length>c.length?p.charAt(c.length):"a";let e=r+p.length;if(T)x=C.substring(e)||"";else{let t=Math.max(0,e-((null==m?void 0:m.start)||0));x=v.substring(t)||""}}else if(k=a,T){let e=r+ +!!a;x=C.substring(e)||""}else{let e=I+ +!!a;x=v.substring(e)||""}(0,s.useEffect)(()=>{if(y.current&&d.current)try{let e=y.current,t=d.current,r=e.getBoundingClientRect(),n=t.getBoundingClientRect();if(!(r.top>=n.top&&r.bottom<=n.bottom)){let r=e.offsetTop-t.clientHeight/2+e.offsetHeight/2;t.scrollTo({top:r,behavior:"smooth"})}}catch(e){console.error("フォーカス文字のスクロール処理エラー:",e)}},[r,a,k,i]),(0,s.useEffect)(()=>{d.current&&g.current&&r>0&&(d.current.scrollLeft=0)},[m,r]);let _="".concat(o().typingText," ").concat(u||""," ").concat(l?o().errorShake:"");if(!C)return(0,n.jsx)("div",{className:_,ref:d,children:(0,n.jsx)("span",{className:o().typingCursor})});let R=!T&&S&&m.start>0?"...":"",K=!T&&S&&m.end<C.length?"...":"";return(0,n.jsx)("div",{className:_,ref:d,children:(0,n.jsxs)("div",{className:o().typingTextContent,ref:g,children:[R&&(0,n.jsx)("span",{className:o().ellipsis,children:R}),h&&(0,n.jsx)("span",{className:o().typed,children:T?h:v.substring(0,Math.min(I,v.length))}),"consonant"===i&&b&&(0,n.jsx)("span",{className:o().consonant,children:b}),k&&(0,n.jsx)("span",{className:o().nextChar,ref:y,children:k}),"        ","consonant"===i&&"string"==typeof p&&p.length>((null==c?void 0:c.length)||0)+1&&(0,n.jsx)("span",{className:o().currentCharRemaining,children:p.substring(((null==c?void 0:c.length)||0)+1)}),x&&(0,n.jsx)("span",{className:o().remaining,children:x}),K&&(0,n.jsx)("span",{className:o().ellipsis,children:K}),(0,n.jsx)("span",{className:o().typingCursor})]})})});l.displayName="SimpleTypingDisplay";let u=l}}]);