(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[662],{1705:(e,t,r)=>{Promise.resolve().then(r.bind(r,8587))},5695:(e,t,r)=>{"use strict";var s=r(8999);r.o(s,"useRouter")&&r.d(t,{useRouter:function(){return s.useRouter}})},7062:(e,t,r)=>{"use strict";r.d(t,{A2:()=>o,LV:()=>u});let s=Symbol("Comlink.proxy"),n=Symbol("Comlink.endpoint"),o=Symbol("Comlink.releaseProxy"),i=Symbol("Comlink.finalizer"),a=Symbol("Comlink.thrown"),c=e=>"object"==typeof e&&null!==e||"function"==typeof e,l=new Map([["proxy",{canHandle:e=>c(e)&&e[s],serialize(e){let{port1:t,port2:r}=new MessageChannel;return function e(t,r=globalThis,n=["*"]){r.addEventListener("message",function o(c){let l;if(!c||!c.data)return;if(!function(e,t){for(let r of e)if(t===r||"*"===r||r instanceof RegExp&&r.test(t))return!0;return!1}(n,c.origin))return void console.warn(`Invalid origin '${c.origin}' for comlink proxy`);let{id:u,type:g,path:h}=Object.assign({path:[]},c.data),m=(c.data.argumentList||[]).map(S);try{var p,_,k;let r=h.slice(0,-1).reduce((e,t)=>e[t],t),n=h.reduce((e,t)=>e[t],t);switch(g){case"GET":l=n;break;case"SET":r[h.slice(-1)[0]]=S(c.data.value),l=!0;break;case"APPLY":l=n.apply(r,m);break;case"CONSTRUCT":p=new n(...m),l=Object.assign(p,{[s]:!0});break;case"ENDPOINT":{let{port1:r,port2:s}=new MessageChannel;e(t,s),_=r,k=[r],f.set(_,k),l=_}break;case"RELEASE":l=void 0;break;default:return}}catch(e){l={value:e,[a]:0}}Promise.resolve(l).catch(e=>({value:e,[a]:0})).then(e=>{let[s,n]=w(e);r.postMessage(Object.assign(Object.assign({},s),{id:u}),n),"RELEASE"===g&&(r.removeEventListener("message",o),d(r),i in t&&"function"==typeof t[i]&&t[i]())}).catch(e=>{let[t,s]=w({value:TypeError("Unserializable return value"),[a]:0});r.postMessage(Object.assign(Object.assign({},t),{id:u}),s)})}),r.start&&r.start()}(e,t),[r,[r]]},deserialize:e=>(e.start(),u(e))}],["throw",{canHandle:e=>c(e)&&a in e,serialize({value:e}){let t;return[e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[]]},deserialize(e){if(e.isError)throw Object.assign(Error(e.value.message),e.value);throw e.value}}]]);function d(e){"MessagePort"===e.constructor.name&&e.close()}function u(e,t){let r=new Map;return e.addEventListener("message",function(e){let{data:t}=e;if(!t||!t.id)return;let s=r.get(t.id);if(s)try{s(t)}finally{r.delete(t.id)}}),function e(t,r,s=[],i=function(){}){let a=!1,c=new Proxy(i,{get(n,i){if(g(a),i===o)return()=>{p&&p.unregister(c),h(t),r.clear(),a=!0};if("then"===i){if(0===s.length)return{then:()=>c};let e=k(t,r,{type:"GET",path:s.map(e=>e.toString())}).then(S);return e.then.bind(e)}return e(t,r,[...s,i])},set(e,n,o){g(a);let[i,c]=w(o);return k(t,r,{type:"SET",path:[...s,n].map(e=>e.toString()),value:i},c).then(S)},apply(o,i,c){g(a);let l=s[s.length-1];if(l===n)return k(t,r,{type:"ENDPOINT"}).then(S);if("bind"===l)return e(t,r,s.slice(0,-1));let[d,u]=_(c);return k(t,r,{type:"APPLY",path:s.map(e=>e.toString()),argumentList:d},u).then(S)},construct(e,n){g(a);let[o,i]=_(n);return k(t,r,{type:"CONSTRUCT",path:s.map(e=>e.toString()),argumentList:o},i).then(S)}}),l=(m.get(t)||0)+1;return m.set(t,l),p&&p.register(c,t,c),c}(e,r,[],t)}function g(e){if(e)throw Error("Proxy has been released and is not useable")}function h(e){return k(e,new Map,{type:"RELEASE"}).then(()=>{d(e)})}let m=new WeakMap,p="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{let t=(m.get(e)||0)-1;m.set(e,t),0===t&&h(e)});function _(e){var t;let r=e.map(w);return[r.map(e=>e[0]),(t=r.map(e=>e[1]),Array.prototype.concat.apply([],t))]}let f=new WeakMap;function w(e){for(let[t,r]of l)if(r.canHandle(e)){let[s,n]=r.serialize(e);return[{type:"HANDLER",name:t,value:s},n]}return[{type:"RAW",value:e},f.get(e)||[]]}function S(e){switch(e.type){case"HANDLER":return l.get(e.name).deserialize(e.value);case"RAW":return e.value}}function k(e,t,r,s){return new Promise(n=>{let o=[,,,,].fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");t.set(o,n),e.start&&e.start(),e.postMessage(Object.assign({id:o},r),s)})}},8432:e=>{e.exports={container:"settings_container__2ie5P",header:"settings_header__mjwXi",backButton:"settings_backButton__gCu75",section:"settings_section__l21lP",testButton:"settings_testButton__VLp7X",loading:"settings_loading__xABMV",diagnosticButton:"settings_diagnosticButton__SCTh1",testResults:"settings_testResults__pTqrn",resultItem:"settings_resultItem__69Rw1",faster:"settings_faster__qZUoB",slower:"settings_slower__J7dEc",resultNote:"settings_resultNote__rTB4J",errorMessage:"settings_errorMessage__YJSxc",settingStatus:"settings_settingStatus__xCMjf",settingsLoaded:"settings_settingsLoaded__QwLbz",settingsLoading:"settings_settingsLoading__pH3Ve",pulse:"settings_pulse__9ZvC1",supportStatus:"settings_supportStatus__Adwor",unsupportedStatus:"settings_unsupportedStatus__RKNHa",warning:"settings_warning__XSvd1",partialResult:"settings_partialResult__T8a3r"}},8524:e=>{e.exports={container:"ProcessingModeSelector_container__32Rak",title:"ProcessingModeSelector_title__S74Xa",modeSection:"ProcessingModeSelector_modeSection__DirIc",modeOptions:"ProcessingModeSelector_modeOptions__w8QGR",modeOption:"ProcessingModeSelector_modeOption__QjrLY",disabled:"ProcessingModeSelector_disabled__Zk7F1",status:"ProcessingModeSelector_status__vpVqH",statusDot:"ProcessingModeSelector_statusDot__k9puX",active:"ProcessingModeSelector_active__efVu5",inactive:"ProcessingModeSelector_inactive__EGvYH",info:"ProcessingModeSelector_info__VB1d0",infoText:"ProcessingModeSelector_infoText__14h4_",warning:"ProcessingModeSelector_warning__wXLvC",infoDetails:"ProcessingModeSelector_infoDetails__fAgtw",notSupported:"ProcessingModeSelector_notSupported__2Jm0A",savedNotification:"ProcessingModeSelector_savedNotification__spo65",fadeInOut:"ProcessingModeSelector_fadeInOut__ihZ0n"}},8587:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>h});var s=r(5155),n=r(2115),o=r(8432),i=r.n(o),a=r(3055);function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{typing:"main-thread",effects:"worker",statistics:"worker"},[t,r]=(0,n.useState)(e),[s,o]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{if(!s&&void 0!==a.A){var t,n,i;let s={typing:(null==(t=a.A.processingMode)?void 0:t.typing)||e.typing,effects:(null==(n=a.A.processingMode)?void 0:n.effects)||e.effects,statistics:(null==(i=a.A.processingMode)?void 0:i.statistics)||e.statistics};try{if("function"!=typeof a.A.setProcessingModes){console.error("[処理モード] setProcessingModesメソッドが存在しません"),r(s),o(!0);return}let e=a.A.setProcessingModes(s);e instanceof Promise?e.then(e=>{console.log("[処理モード] 初期設定完了:",e),r(e.currentModes||s),o(!0)}).catch(e=>{console.error("[処理モード] 初期設定エラー:",e),r(s),o(!0)}):(console.log("[処理モード] 同期的に初期設定完了"),r(s),o(!0))}catch(e){console.error("[処理モード] 初期設定例外:",e),r(s),o(!0)}}},[s,e]),{modes:t,changeMode:(e,s)=>{if("typing"===e)return console.warn("[処理モード] タイピング処理モードは変更できません。"),Promise.resolve({success:!1,message:"タイピング処理モードは変更できません。",currentModes:t});if(!["effects","statistics"].includes(e)||!["worker","main-thread"].includes(s))return Promise.reject(Error("無効なモード設定"));let n={...t,[e]:s};return a.A.setProcessingModes(n).then(e=>(r(e.currentModes||n),e))},isInitialized:s}}class l{calculateScore(e,t){let r=performance.now();try{let s=this._calculateScoreOnMainThread(e);t&&t(s),this.metrics.calculationCalls++,this.metrics.totalProcessingTime+=performance.now()-r}catch(e){console.error("[ScoreWorkerManager] スコア計算エラー:",e),t&&t({error:e.message,score:0})}}_calculateScoreOnMainThread(e){let{correctKeyCount:t=0,missCount:r=0,typingTime:s=0,textLength:n=0,level:o="normal"}=e,i=0,a=0,c=100;if(s>0){a=Math.round(t/(s/6e4));let e=t+r;e>0&&(c=Math.round(t/e*100)),i=Math.round(c/100*a)}let l=1;switch(o){case"easy":l=.8;break;case"normal":l=1;break;case"hard":l=1.2;break;case"expert":l=1.5}return{score:Math.round(i*l),wpm:a,accuracy:c,level:o,correctKeyCount:t,missCount:r,typingTime:s}}getMetrics(){return{...this.metrics}}setProcessingModes(e){return console.log("[ScoreWorkerManager] 処理モード設定:",e),e.calculation&&(this.processingMode.calculation="main-thread"),e.effects&&(this.processingMode.effects="main-thread"),{success:!0,currentModes:{...this.processingMode}}}static getInstance(){return this.instance||(this.instance=new l),this.instance}constructor(){this.callbacks=new Map,this.nextCallbackId=1,this.processingMode={calculation:"main-thread",effects:"main-thread"},this.metrics={calculationCalls:0,totalProcessingTime:0},console.log("[ScoreWorkerManager] メインスレッドモードで初期化しました")}}let d=l.getInstance();r(8524);let u=()=>{let{modes:e,changeMode:t}=c(),[r,s]=(0,n.useState)(e),[o,i]=(0,n.useState)(!0),[a,l]=(0,n.useState)(!1)};var g=r(5695);function h(){let e=(0,g.useRouter)(),{modes:t,isInitialized:r}=c(),[o,a]=(0,n.useState)(!1),[l,h]=(0,n.useState)(null),[m,p]=(0,n.useState)(!1),[_,f]=(0,n.useState)(!0);(0,n.useEffect)(()=>{a(!0),f("undefined"!=typeof Worker&&!d.fallbackMode)},[]);let w=async()=>{p(!0),h(null);try{let e={correctKeyCount:1500,missCount:20,typingTime:6e4,textLength:2e3,level:"hard"};if(!_){h({error:"このブラウザはWebWorkerをサポートしていないか、初期化に失敗したため、テストを実行できません。",workerTime:"N/A",mainThreadTime:"計測中..."});let t=performance.now(),r=await new Promise(t=>{d.calculateScore(e,e=>{t(e)})}),s=performance.now()-t;h({error:"WebWorkerは非対応のためテストされません",workerTime:"N/A",mainThreadTime:s.toFixed(2),workerScore:"N/A",mainThreadScore:r.score,workerSupported:!1}),p(!1);return}if((await d.setProcessingModes({calculation:"worker"})).adjusted){h({error:"WebWorkerモードへの切り替えに失敗しました。このブラウザではWebWorkerをサポートしていないか、初期化に失敗しています。",workerTime:"N/A",mainThreadTime:"計測中..."});let t=performance.now(),r=await new Promise(t=>{d.calculateScore(e,e=>{t(e)})}),s=performance.now()-t;h({error:"WebWorkerは非対応のためテストされません",workerTime:"N/A",mainThreadTime:s.toFixed(2),workerScore:"N/A",mainThreadScore:r.score,workerSupported:!1}),p(!1);return}await new Promise(e=>setTimeout(e,200));let r=performance.now(),s=await new Promise(t=>{d.calculateScore(e,e=>{t(e)})}),n=performance.now()-r;d.setProcessingModes({calculation:"main-thread"}),await new Promise(e=>setTimeout(e,200));let o=performance.now(),i=await new Promise(t=>{d.calculateScore(e,e=>{t(e)})}),a=performance.now()-o;d.setProcessingModes({calculation:t.calculation}),h({workerTime:n.toFixed(2),mainThreadTime:a.toFixed(2),difference:(a/n-1)*100,workerScore:s.score,mainThreadScore:i.score,workerSupported:!0})}catch(e){console.error("スピードテストエラー:",e),h({error:e.message||"テスト実行中に予期せぬエラーが発生しました",workerSupported:_}),d.setProcessingModes({calculation:t.calculation})}finally{p(!1)}};return o?(0,s.jsxs)("div",{className:i().container,children:[(0,s.jsxs)("div",{className:i().header,children:[(0,s.jsx)("h1",{children:"ゲーム設定"}),(0,s.jsx)("button",{className:i().backButton,onClick:()=>e.push("/"),children:"メインメニューに戻る"})]}),(0,s.jsxs)("div",{className:i().section,children:[(0,s.jsx)("h2",{children:"処理モード設定"}),(0,s.jsx)("p",{children:"タイピングゲームの処理方法を設定できます。パフォーマンスに影響します。"}),(0,s.jsxs)("div",{className:i().settingStatus,children:[(0,s.jsx)("div",{className:r?i().settingsLoaded:i().settingsLoading,children:r?"設定が読み込まれました":"設定を読み込み中..."}),(0,s.jsxs)("div",{className:_?i().supportStatus:i().unsupportedStatus,children:["WebWorker: ",_?"対応":"非対応"]})]}),(0,s.jsx)(u,{})]}),(0,s.jsxs)("div",{className:i().section,children:[(0,s.jsx)("h2",{children:"WebWorker診断"}),(0,s.jsx)("p",{children:"ブラウザのWebWorkerサポート状況と関連問題を診断します"}),(0,s.jsx)("button",{className:i().diagnosticButton,onClick:()=>{window.open("/worker-test.html","_blank","width=800,height=600")},children:"詳細診断を実行"}),!_&&(0,s.jsxs)("div",{className:i().warning,children:[(0,s.jsx)("strong",{children:"注意:"})," お使いのブラウザはWebWorkerをサポートしていないか、初期化に失敗しました。 「詳細診断を実行」ボタンをクリックすると、詳細な診断情報が確認できます。"]})]}),(0,s.jsxs)("div",{className:i().section,children:[(0,s.jsx)("h2",{children:"WebWorkerパフォーマンステスト"}),(0,s.jsx)("p",{children:"WebWorkerとメインスレッドのスコア計算速度を比較します"}),!_&&(0,s.jsxs)("div",{className:i().warning,children:[(0,s.jsx)("strong",{children:"注意:"})," お使いのブラウザはWebWorkerをサポートしていないか、初期化に失敗しました。 メインスレッドのパフォーマンスのみテストされます。"]}),(0,s.jsx)("button",{className:"".concat(i().testButton," ").concat(m?i().loading:""),onClick:w,disabled:m,children:m?"テスト実行中...":"スピードテストを実行"}),l&&!l.error&&(0,s.jsxs)("div",{className:i().testResults,children:[(0,s.jsx)("h3",{children:"テスト結果"}),(0,s.jsxs)("div",{className:i().resultItem,children:[(0,s.jsx)("span",{children:"WebWorker処理時間:"}),(0,s.jsx)("strong",{children:l.workerSupported?"".concat(l.workerTime," ミリ秒"):"非対応"})]}),(0,s.jsxs)("div",{className:i().resultItem,children:[(0,s.jsx)("span",{children:"メインスレッド処理時間:"}),(0,s.jsxs)("strong",{children:[l.mainThreadTime," ミリ秒"]})]}),l.workerSupported&&(0,s.jsxs)("div",{className:i().resultItem,children:[(0,s.jsx)("span",{children:"差異:"}),(0,s.jsx)("strong",{className:l.difference>0?i().faster:i().slower,children:l.difference>0?"WebWorkerが約".concat(Math.abs(l.difference).toFixed(1),"%高速"):"メインスレッドが約".concat(Math.abs(l.difference).toFixed(1),"%高速")})]}),(0,s.jsx)("div",{className:i().resultNote,children:"スコア計算中も画面は完全に反応したままです。これがWebWorkerの最大の利点です。"})]}),l&&l.error&&(0,s.jsxs)("div",{className:i().errorMessage,children:[l.error,l.mainThreadTime&&(0,s.jsx)("div",{className:i().partialResult,children:(0,s.jsxs)("p",{children:["メインスレッド処理時間: ",l.mainThreadTime," ミリ秒"]})})]})]})]}):null}}},e=>{var t=t=>e(e.s=t);e.O(0,[449,740,55,441,684,358],()=>t(1705)),_N_E=e.O()}]);