"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[55],{1603:(e,t,r)=>{r.d(t,{AG:()=>a,DS:()=>s,dZ:()=>l,lo:()=>i});var n=r(8740);let c={inputResults:new Map,coloringInfo:new Map,expectedKeys:new Map},o={processCalls:0,cacheHits:0,cacheMisses:0,totalProcessingTime:0};function s(e,t){o.processCalls++;let r=performance.now();try{if(!e||!t||0===t.length)return{success:!1,error:"無効な入力"};let s="".concat(e.currentCharIndex||0,"_").concat(e.text||"","_").concat(e.currentInput||"","_").concat(t);if(c.inputResults.has(s))return o.cacheHits++,c.inputResults.get(s);o.cacheMisses++;let{text:a="",currentCharIndex:i=0,currentInput:l="",completed:u=!1,patterns:h=null}=e;if(u)return{success:!1,alreadyCompleted:!0};let p=a.charAt(i)||"",m=a.substring(i),g=!1,f=l+t,y=i,d=!1;if(h&&m.length>0){for(let e of h)if(e.source&&m.startsWith(e.source)){let t=e.target||"";if(t.startsWith(f)){g=!0,f===t&&(y+=e.source.length,f="");break}}}else if(n.Q0(p)||n.JD(p)){let e=n.zU(f,{IMEMode:!0});m.startsWith(e)&&(g=!0,e.length>0&&0===m.indexOf(e)&&(y+=e.length,f=""))}else p.toLowerCase()===t.toLowerCase()&&(g=!0,y++,f="");d=y>=a.length;let k={success:!0,isCorrect:g,newState:{currentCharIndex:y,currentInput:f,completed:d},metrics:{processingTime:performance.now()-r,timestamp:Date.now()}};if(c.inputResults.set(s,k),c.inputResults.size>1e3)for(let e of Array.from(c.inputResults.keys()).slice(0,200))c.inputResults.delete(e);let M=performance.now();return o.totalProcessingTime+=M-r,k}catch(e){return console.error("タイピング処理エラー:",e),{success:!1,error:e.message||"タイピング処理中にエラーが発生しました",metrics:{processingTime:performance.now()-r,timestamp:Date.now()}}}}function a(e){let t=performance.now();try{if(!e)return{success:!1,error:"無効なセッション"};let r="color_".concat(e.currentCharIndex||0,"_").concat(e.text||"","_").concat(e.currentInput||"","_").concat(+!!e.completed);if(c.coloringInfo.has(r))return o.cacheHits++,c.coloringInfo.get(r);o.cacheMisses++;let{text:n="",currentCharIndex:s=0,currentInput:a="",completed:i=!1}=e,l={typed:n.substring(0,s),current:{expected:n.charAt(s)||"",input:a},remaining:n.substring(s+1),isCompleted:i,metrics:{processingTime:performance.now()-t,timestamp:Date.now()}},u={success:!0,coloringInfo:l};if(c.coloringInfo.set(r,u),c.coloringInfo.size>500)for(let e of Array.from(c.coloringInfo.keys()).slice(0,100))c.coloringInfo.delete(e);return u}catch(e){return console.error("色分け情報取得エラー:",e),{success:!1,error:e.message||"色分け情報の取得中にエラーが発生しました",metrics:{processingTime:performance.now()-t,timestamp:Date.now()}}}}function i(e){let t=performance.now();try{if(!e)return{success:!1,error:"無効なセッション"};if(e.completed)return{success:!0,key:""};let r="next_".concat(e.currentCharIndex||0,"_").concat(e.text||"","_").concat(e.currentInput||"");if(c.expectedKeys.has(r))return o.cacheHits++,c.expectedKeys.get(r);o.cacheMisses++;let{text:n="",currentCharIndex:s=0,currentInput:a=""}=e,i=(n.charAt(s)||"").toLowerCase(),l={success:!0,key:i,metrics:{processingTime:performance.now()-t,timestamp:Date.now()}};return c.expectedKeys.set(r,l),l}catch(e){return console.error("次のキー取得エラー:",e),{success:!1,error:e.message||"次のキー取得中にエラーが発生しました",key:"",metrics:{processingTime:performance.now()-t,timestamp:Date.now()}}}}function l(){return c.inputResults.clear(),c.coloringInfo.clear(),c.expectedKeys.clear(),{success:!0}}},3055:(e,t,r)=>{r.d(t,{A:()=>s});var n=r(1603),c=r(5792);class o{isInitialized(){return!0}getNextExpectedKey(e,t){let r=performance.now();try{let c=(0,n.lo)(e);t&&t(c),this.sharedState.nextExpectedKey=c.nextKey,this.sharedState.lastUpdateTimestamp=Date.now(),this.metrics.mainThreadProcessCalls++,this.metrics.mainThreadProcessingTime+=performance.now()-r}catch(e){console.error("[TypingWorkerManager] getNextExpectedKey エラー:",e),t&&t({error:e.message,nextKey:""})}}processTypingInput(e,t){let r=performance.now();try{let c=(0,n.DS)(e);t&&t(c),this.metrics.mainThreadProcessCalls++,this.metrics.mainThreadProcessingTime+=performance.now()-r}catch(e){console.error("[TypingWorkerManager] processTypingInput エラー:",e),t&&t({error:e.message})}}getColoringInfo(e,t){let r=performance.now();try{let c=(0,n.AG)(e);t&&t(c),this.metrics.mainThreadProcessCalls++,this.metrics.mainThreadProcessingTime+=performance.now()-r}catch(e){console.error("[TypingWorkerManager] getColoringInfo エラー:",e),t&&t({error:e.message})}}clearCache(){this.cache.inputResults.clear(),this.cache.coloringInfo.clear(),(0,n.dZ)(),console.log("[TypingWorkerManager] キャッシュをクリアしました")}getMetrics(){return{...this.metrics}}getQueueLength(){return this.queue.length}setProcessingModes(e){return e.typing&&(this.processingMode.typing="main-thread"),e.effects&&(this.processingMode.effects="main-thread"),e.statistics&&(this.processingMode.statistics="main-thread"),{success:!0,currentModes:{...this.processingMode}}}async cleanup(){try{return console.log("[TypingWorkerManager] リソースクリーンアップ開始"),this.cache.inputResults.clear(),this.cache.coloringInfo.clear(),(0,n.dZ)(),c.A.cleanup(),console.log("[TypingWorkerManager] リソースクリーンアップ完了"),{success:!0}}catch(e){return console.error("[TypingWorkerManager] クリーンアップエラー:",e),{success:!1,error:e}}}static getInstance(){return this.instance||(this.instance=new o),this.instance}constructor(){this.callbacks=new Map,this.nextCallbackId=1,this.queue=[],this.processingMode={typing:"main-thread",effects:"main-thread",statistics:"main-thread"},this.metrics={processCalls:0,cacheMisses:0,cacheHits:0,processingTime:0,lastSync:Date.now(),mainThreadProcessCalls:0,mainThreadProcessingTime:0},this.cache={inputResults:new Map,coloringInfo:new Map},this.sharedState={nextExpectedKey:"",inputMode:"normal",lastUpdateTimestamp:0},window.typingWorkerManager=this,console.log("[TypingWorkerManager] メインスレッドモードで初期化しました")}}let s=o.getInstance()},3712:(e,t,r)=>{r.d(t,{MO:()=>l,Sz:()=>c});var n=r(7062);let c=()=>{try{return"undefined"!=typeof Worker&&"undefined"!=typeof URL&&"function"==typeof URL.createObjectURL}catch(e){return console.warn("Worker API利用可能性チェックエラー:",e),!1}},o=()=>Math.random().toString(36).substring(2,15);class s{initialize(){if(this.worker||this.terminated)return this;try{if(!c())return console.warn("Worker API利用不可: フォールバック関数を使用します (".concat(this.id,")")),this;let e=new Blob([this.workerCode],{type:"application/javascript"}),t=URL.createObjectURL(e);this.worker=new Worker(t,this.options),this.proxy=n.LV(this.worker),this.active=!0,URL.revokeObjectURL(t)}catch(e){console.error("Worker初期化エラー:",e),this.close()}return this}close(){try{this.worker&&this.worker.terminate(),this.proxy&&this.proxy[n.A2]()}catch(e){console.warn("Worker終了エラー:",e)}this.worker=null,this.proxy=null,this.active=!1,this.terminated=!0}async call(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(this.worker||this.terminated||this.initialize(),!this.active){if(this.fallback&&"function"==typeof this.fallback[e])return this.fallback[e](...r);throw Error("Worker使用不可: ".concat(e,"のフォールバック実装がありません"))}try{return await this.proxy[e](...r)}catch(t){if(console.error("Worker実行エラー (".concat(e,"):"),t),this.fallback&&"function"==typeof this.fallback[e])return console.warn("Worker実行失敗: フォールバック関数を使用します (".concat(e,")")),this.fallback[e](...r);throw t}}constructor(e,t={}){this.id=o(),this.active=!1,this.options=t,this.workerCode=e,this.worker=null,this.proxy=null,this.fallback=t.fallback||null,this.terminated=!1}}class a{createWorker(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new s(e,t);return this.workers.set(r.id,r),r}closeWorker(e){let t=this.workers.get(e);t&&(t.close(),this.workers.delete(e))}closeAll(){for(let[e,t]of this.workers.entries())t.close(),this.workers.delete(e)}constructor(){this.workers=new Map,window.addEventListener("beforeunload",()=>this.closeAll())}}let i=new a;function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n="\n    importScripts('https://unpkg.com/comlink/dist/umd/comlink.js');\n    \n    // Worker内で実行する関数\n    const workerFunction = ".concat(e.toString(),";\n    \n    // Comlinkを使用して関数をエクスポート\n    self.onmessage = function(e) {\n      Comlink.expose(workerFunction(), self);\n    };\n    \n    // 即時実行\n    self.postMessage(null);\n  "),c=i.createWorker(n,{...r,fallback:t});c.initialize();let o={};return t&&Object.keys(t).forEach(e=>{"function"==typeof t[e]&&(o[e]=async function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return c.call(e,...r)})}),{instance:c,callMethod:async function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return c.call(e,...r)},...o}}},5792:(e,t,r)=>{let n;r.d(t,{A:()=>i});var c=r(3712);let o=()=>({calculateKPM(e){if(!e||!e.keyCount||!e.elapsedTimeMs)return{kpm:0,rank:"F"};try{let t=e.elapsedTimeMs/6e4,r=Math.floor(e.keyCount/t),n="F";return r>=400?n="S":r>=300?n="A":r>=200?n="B":r>=150?n="C":r>=100?n="D":r>=50&&(n="E"),{kpm:r,rank:n,normalized:Math.min(r,600),accuracy:e.accuracy||(e=>{if(!e||!e.correctKeyCount||!e.totalKeyCount)return 0;let t=e.correctKeyCount/e.totalKeyCount*100;return Math.min(Math.max(0,Math.round(10*t)/10),100)})(e),timeStamp:new Date().toISOString(),isWorker:!0}}catch(e){return console.error("Worker内でのKPM計算エラー:",e),{kpm:0,rank:"F",error:e.message}}},calculateAverageKPM(e){if(!Array.isArray(e)||0===e.length)return{kpm:0,rank:"F"};try{let t=e.filter(e=>e&&e.problemKeyCount>0&&e.problemElapsedMs>0);if(0===t.length)return{kpm:0,rank:"F"};let r=t.map(e=>{let t=e.problemKeyCount||0,r=e.problemElapsedMs||0;return t<=0||r<=0?0:t/(r/6e4)}),n=r.reduce((e,t)=>e+t,0),c=Math.floor(r.length>0?n/r.length:0),o="F";return c>=400?o="S":c>=300?o="A":c>=200?o="B":c>=150?o="C":c>=100?o="D":c>=50&&(o="E"),{kpm:Math.min(c,600),rank:o,rawKpm:c,sampleCount:t.length,timeStamp:new Date().toISOString()}}catch(e){return console.error("Worker内での平均KPM計算エラー:",e),{kpm:0,rank:"F",error:e.message}}},calculateAccuracy(e){if(!e||!e.correctKeyCount||!e.totalKeyCount)return 0;try{let t=e.correctKeyCount/e.totalKeyCount*100;return Math.min(Math.max(0,Math.round(10*t)/10),100)}catch(e){return console.error("Worker内での精度計算エラー:",e),0}}}),s={calculateKPM(e){if(!e||!e.keyCount||!e.elapsedTimeMs)return{kpm:0,rank:"F"};let t=e.elapsedTimeMs/6e4,r=Math.floor(e.keyCount/t),n="F";return r>=400?n="S":r>=300?n="A":r>=200?n="B":r>=150?n="C":r>=100?n="D":r>=50&&(n="E"),{kpm:r,rank:n,normalized:Math.min(r,600),accuracy:e.accuracy||(e&&e.correctKeyCount&&e.totalKeyCount?Math.min(Math.max(0,Math.round(10*(e.correctKeyCount/e.totalKeyCount*100))/10),100):0),timeStamp:new Date().toISOString(),isWorker:!1}},calculateAverageKPM(e){if(!Array.isArray(e)||0===e.length)return{kpm:0,rank:"F"};let t=e.filter(e=>e&&e.problemKeyCount>0&&e.problemElapsedMs>0);if(0===t.length)return{kpm:0,rank:"F"};let r=t.map(e=>{let t=e.problemKeyCount||0,r=e.problemElapsedMs||0;return t<=0||r<=0?0:t/(r/6e4)}),n=r.reduce((e,t)=>e+t,0),c=Math.floor(r.length>0?n/r.length:0),o="F";return c>=400?o="S":c>=300?o="A":c>=200?o="B":c>=150?o="C":c>=100?o="D":c>=50&&(o="E"),{kpm:Math.min(c,600),rank:o,rawKpm:c,sampleCount:t.length,timeStamp:new Date().toISOString(),isWorker:!1}},calculateAccuracy:e=>e&&e.correctKeyCount&&e.totalKeyCount?Math.min(Math.max(0,Math.round(10*(e.correctKeyCount/e.totalKeyCount*100))/10),100):0},a=!1,i={initialize(){if(!a)try{n=(0,c.MO)(o,s),a=!0,(0,c.Sz)()&&n&&n.instance&&n.instance.active}catch(e){console.error("[ScoreCalculationWorker] 初期化エラー:",e)}},async calculateKPM(e){a||this.initialize();try{if(n)return await n.calculateKPM(e);return s.calculateKPM(e)}catch(t){return console.error("[ScoreCalculationWorker] KPM計算エラー:",t),s.calculateKPM(e)}},async calculateAverageKPM(e){a||this.initialize();try{if(n)return await n.calculateAverageKPM(e);return s.calculateAverageKPM(e)}catch(t){return console.error("[ScoreCalculationWorker] 平均KPM計算エラー:",t),s.calculateAverageKPM(e)}},async calculateAccuracy(e){a||this.initialize();try{if(n)return await n.callMethod("calculateAccuracy",e);return s.calculateAccuracy(e)}catch(t){return console.error("[ScoreCalculationWorker] 精度計算エラー:",t),s.calculateAccuracy(e)}},cleanup(){n&&n.instance&&n.instance.close(),a=!1}}}}]);