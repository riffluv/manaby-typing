"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[334],{5334:(e,t,r)=>{r.r(t),r.d(t,{default:()=>h});var n=r(5155),s=r(9137),i=r.n(s),a=r(2115),o=r(7062);let c=()=>{try{return"undefined"!=typeof Worker&&"undefined"!=typeof URL&&"function"==typeof URL.createObjectURL}catch(e){return console.warn("[WorkerManager] WebWorker API利用可能性チェックエラー:",e),!1}},l=e=>{let t=new Blob(["\n    // WorkerManager: ".concat(e,"\n    try {\n      importScripts('").concat(e,"');\n    } catch (e) {\n      console.error('[WorkerManager] Worker importScripts failed:', e);\n      self.postMessage({ type: 'WORKER_ERROR', error: e.toString() });\n    }\n  ")],{type:"application/javascript"});return URL.createObjectURL(t)};class u{initialize(){if(!this.isReady&&!this.initializing){this.initializing=!0;try{let e;if(!c()){console.warn("[WorkerManager] WebWorkerが利用できません。フォールバックモードで実行します: ".concat(this.workerPath)),this._setupFallbackMode();return}let t=this.workerPath;{let e=window.location.origin;t.startsWith("http")||t.startsWith("blob:")||(t="".concat(e).concat(t.startsWith("/")?"":"/").concat(t))}try{this.options.useImportScripts?(e=l(t),this.worker=new Worker(e)):this.worker=new Worker(t)}catch(e){console.error("[WorkerManager] Worker作成エラー:",e),this._setupFallbackMode();return}this.proxy=o.LV(this.worker),this._setupHeartbeat(),this.isReady=!0,this.initializing=!1,this._triggerEvent("WORKER_READY",{mode:"worker"}),this._processQueue(),console.log("[WorkerManager] WebWorkerモードで初期化完了: ".concat(this.workerPath))}catch(e){console.error("[WorkerManager] 初期化エラー:",e),this._setupFallbackMode()}}}_setupFallbackMode(){this.fallbackMode=!0,this.isReady=!0,this.initializing=!1,this._triggerEvent("WORKER_READY",{mode:"fallback"}),this._processQueue(),console.warn("[WorkerManager] フォールバックモードで初期化完了: ".concat(this.workerPath))}_setupHeartbeat(){this.heartbeatInterval||(this.heartbeatInterval=setInterval(()=>{if(!this.worker)return;let e=Date.now();if(this.lastHeartbeat>0&&e-this.lastHeartbeat>5e3){console.warn("[WorkerManager] Workerの応答がありません。再初期化します。"),this._restartWorker();return}this.sendMessage("PING",{timestamp:e}),this.lastHeartbeat=e},3e4))}_restartWorker(){this.terminate(),this.initializing=!1,this.isReady=!1,this.initialize()}_processQueue(){if(0===this.messageQueue.length)return;console.log("[WorkerManager] 保留中のメッセージを処理: ".concat(this.messageQueue.length,"件"));let e=[...this.messageQueue];for(let{type:t,data:r,callback:n}of(this.messageQueue=[],e))this.sendMessage(t,r,n)}sendMessage(e,t,r){if(!this.isReady){this.initializing||this.initialize(),this.messageQueue.push({type:e,data:t,callback:r});return}if(this.fallbackMode)return void this._processFallbackMessage(e,t,r);this._sendWorkerMessage(e,t,r)}async _sendWorkerMessage(e,t,r){try{if(!this.proxy)throw Error("Worker proxyが初期化されていません");let n=await this.proxy.processMessage(e,t);"PING"===e&&n&&"PONG"===n.type&&(this.lastHeartbeat=Date.now()),r&&r(n),n&&n.events&&n.events.forEach(e=>{this._triggerEvent(e.name,e.data)})}catch(n){if(console.error("[WorkerManager] Worker通信エラー(".concat(e,"):"),n),n.message.includes("Failed to execute")||n.message.includes("Worker is not defined")||n.message.includes("terminated")){console.warn("[WorkerManager] Worker通信に問題があります。フォールバックモードに切り替えます。"),this._setupFallbackMode(),this._processFallbackMessage(e,t,r);return}r&&r({error:n.message})}}_processFallbackMessage(e,t,r){setTimeout(()=>{try{let t;switch(e){case"PING":t={type:"PONG",timestamp:Date.now()};break;case"START_ANIMATION":this._triggerEvent("ANIMATION_FRAME",{keyStates:{},effects:[],animationProgress:[]}),t={success:!0};break;case"STOP_ANIMATION":case"START_EFFECTS":case"STOP_EFFECTS":t={success:!0};break;case"PROCESS_KEY_EVENT":case"PROCESS_EFFECTS":this._triggerEvent("EFFECTS_UPDATE",{effects:[]}),t={success:!0};break;case"SET_PROCESSING_MODES":t={success:!0,currentModes:{typing:"main-thread",effects:"main-thread",animation:"main-thread",statistics:"main-thread"}};break;default:t={error:"未知のメッセージタイプ: ".concat(e)}}r&&r(t)}catch(t){console.error("[WorkerManager] フォールバック処理エラー(".concat(e,"):"),t),r&&r({error:t.message})}},0)}addEventListener(e,t){return this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t),()=>{this.removeEventListener(e,t)}}removeEventListener(e,t){this.eventListeners[e]&&(this.eventListeners[e]=this.eventListeners[e].filter(e=>e!==t))}_triggerEvent(e,t){if(!this.eventListeners[e])return;let r=Date.now(),n={...t,timestamp:r};this.eventListeners[e].forEach(t=>{try{t(n)}catch(t){console.error("[WorkerManager] イベントハンドラエラー(".concat(e,"):"),t)}})}async setProcessingModes(e){return new Promise(t=>{this.sendMessage("SET_PROCESSING_MODES",{modes:e},e=>{t(e)})})}terminate(){if(this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null),this.worker)try{this.proxy&&(this.proxy[o.A2](),this.proxy=null),this.worker.terminate(),this.worker=null}catch(e){console.warn("[WorkerManager] Worker終了エラー:",e)}this.eventListeners={},this.messageQueue=[],this.isReady=!1,console.log("[WorkerManager] 終了: ".concat(this.workerPath))}constructor(e,t={}){this.workerPath=e,this.options=t,this.worker=null,this.proxy=null,this.isReady=!1,this.eventListeners={},this.messageQueue=[],this.fallbackMode=!1,this.lastHeartbeat=0,this.heartbeatInterval=null,console.log("[WorkerManager] 初期化中: ".concat(e))}}function d(){let e=(0,a.useRef)(null),[t,r]=(0,a.useState)({isRunning:!1,nextKey:"",effects:[],keyStates:{},animationProgress:[],lastUpdate:0}),n=(0,a.useRef)([]);(0,a.useEffect)(()=>{let t=new u("/workers/animation-worker.js");e.current=t;let s=t.addEventListener("ANIMATION_FRAME",e=>{r(t=>({...t,keyStates:e.keyStates||t.keyStates,effects:e.effects||t.effects,animationProgress:e.animationProgress||t.animationProgress,lastUpdate:e.timestamp||Date.now()}))});return n.current.push(s),t.initialize(),()=>{n.current.forEach(e=>e()),n.current=[],t&&t.terminate()}},[]);let s=(0,a.useCallback)(()=>{e.current&&!t.isRunning&&e.current.sendMessage("START_ANIMATION",{},e=>{e.success&&r(e=>({...e,isRunning:!0}))})},[t.isRunning]),i=(0,a.useCallback)(()=>{e.current&&t.isRunning&&e.current.sendMessage("STOP_ANIMATION",{},e=>{e.success&&r(e=>({...e,isRunning:!1}))})},[t.isRunning]),o=(0,a.useCallback)(t=>{e.current&&(r(e=>{let r={...e.keyStates},{key:n,type:s}=t;return"keydown"===s?r[n]={pressed:!0,timestamp:Date.now()}:r[n]&&(r[n].pressed=!1),{...e,keyStates:r}}),e.current.sendMessage("PROCESS_KEY_EVENT",t))},[]);return{animationState:t,startAnimation:s,stopAnimation:i,processKeyEvent:o,addEffect:(0,a.useCallback)(t=>{e.current&&e.current.sendMessage("ADD_EFFECT",t)},[]),updateConfig:(0,a.useCallback)(t=>{e.current&&e.current.sendMessage("UPDATE_CONFIG",{config:t})},[]),isRunning:t.isRunning}}let g=e=>{let{nextKey:t="",lastPressedKey:r="",isError:s=!1,className:i=""}=e,o=(0,a.useRef)(null),{animationState:c,startAnimation:l,stopAnimation:u,handleKeyPress:g,setNextKey:h,isReady:f}=d(),p=(0,a.useMemo)(()=>[[["1","!"],["2",'"'],["3","#"],["4","$"],["5","%"],["6","&"],["7","'"],["8","("],["9",")"],["0",""],["-","="],["^","~"],["\\","|"]],[["q","Q"],["w","W"],["e","E"],["r","R"],["t","T"],["y","Y"],["u","U"],["i","I"],["o","O"],["p","P"],["@","`"],["[","{"]],[["a","A"],["s","S"],["d","D"],["f","F"],["g","G"],["h","H"],["j","J"],["k","K"],["l","L"],[";","+"],[":","*"],["]","}"]],[["z","Z"],["x","X"],["c","C"],["v","V"],["b","B"],["n","N"],["m","M"],[",","<"],[".",">"],["/","?"],["\\","_"]],[["space","space"]]],[]),m=(0,a.useMemo)(()=>({primary:"#FF8C00",primaryLight:"#FFB41E",primaryDark:"#C86400",primaryGlow:"rgba(255, 140, 0, 0.5)",bgDark:"#0A0D14",bgMid:"#0F141E",bgLight:"#191E2D",error:"#FF3C3C",errorGlow:"rgba(255, 60, 60, 0.6)",textLight:"#F0F0F0",textMid:"#C8C8C8",textDim:"#B4B4B4"}),[]);return(0,a.useEffect)(()=>{f&&(t!==c.nextKey&&h(t),r&&g(r,s))},[t,r,s,f,c.nextKey,h,g]),(0,a.useEffect)(()=>{if(!o.current||!f)return;let e=o.current,r=e.getContext("2d"),n=()=>{let t=window.devicePixelRatio||1;return e.width=800*t,e.height=280*t,e.style.width="".concat(800,"px"),e.style.height="".concat(280,"px"),{width:800,height:280,scale:t}},{width:s,height:i,scale:a}=n(),d=()=>n();window.addEventListener("resize",d);let g=(e,t,r)=>{e.strokeStyle="rgba(255, 140, 0, 0.07)",e.lineWidth=1,e.beginPath();for(let n=0;n<r;n+=60)e.moveTo(0,n),e.lineTo(t,n);for(let n=0;n<t;n+=60)e.moveTo(n,0),e.lineTo(n,r);e.stroke()},h=(e,t)=>{e.fillStyle="rgba(10, 13, 20, 0.8)",e.fillRect(t/2-380,40,760,220),e.strokeStyle=m.primary,e.lineWidth=2,e.beginPath(),e.rect(t/2-384,36,768,228),e.stroke(),e.fillStyle=m.primary,e.fillRect(t/2-384-3,33,6,6),e.fillRect(t/2+384-3,33,6,6),e.fillRect(t/2-384-3,261,6,6),e.fillRect(t/2+384-3,261,6,6);let r=t/2-384+Date.now()/3e3%1*768;e.strokeStyle="rgba(255, 140, 0, 0.25)",e.lineWidth=1,e.beginPath(),e.moveTo(r,36),e.lineTo(r,264),e.stroke()},y=(e,r,n)=>{let s=p.reduce((e,t)=>Math.max(e,t.reduce((e,t)=>e+("space"===t[0]?240:48)+5,0)),0),i=(r-s)/2;p.forEach((r,a)=>{let o=i+(s-r.reduce((e,t)=>e+("space"===t[0]?240:48)+5,0))/2,c=50+39*a;r.forEach(r=>{let s,i,[a,l]=r,u="space"===a,d=u?240:48,g=a.toLowerCase(),h=g===(null==t?void 0:t.toLowerCase())&&""!==t,f=n[g],p=(null==f?void 0:f.pressed)||!1,y=(null==f?void 0:f.error)||!1;if(h){s=m.primaryDark,i=m.primary;let t=.5*Math.sin(Date.now()/400)+.5;t>.4&&(e.fillStyle="rgba(255, 140, 0, ".concat(Math.min(.15,.2*t),")"),e.fillRect(o-2,c-2,d+4,38))}else p?y?(s=m.error,i=m.error):(s=m.primaryLight,i=m.primary):(s=m.bgMid,i="rgba(50, 55, 70, 0.8)");if(e.fillStyle=s,e.fillRect(o,c,d,34),e.strokeStyle=i,e.lineWidth=h?2:1,e.strokeRect(o,c,d,34),h&&(e.fillStyle="rgba(255, 200, 100, 0.5)",e.fillRect(o+d-6,c+4,2,2)),e.fillStyle=h||p?m.textLight:m.textMid,e.font="bold ".concat(u?14:13,"px monospace"),e.textAlign="center",e.textBaseline="middle",u?(e.fillText("SPACE",o+d/2,c+17),h&&(e.strokeStyle="rgba(255, 140, 0, 0.5)",e.beginPath(),e.moveTo(o+15,c+17),e.lineTo(o+d-15,c+17),e.stroke())):(e.fillText(a.toUpperCase(),o+d/2,c+17),h&&l&&l!==a.toUpperCase()&&(e.fillStyle=m.textDim,e.font="bold 8px monospace",e.fillText(l,o+d-8,c+8))),h){let t=Date.now()/600,r=1.5*Math.sin(t),n=.4+.15*Math.sin(t);e.strokeStyle="rgba(255, 154, 40, ".concat(n.toFixed(2),")"),e.lineWidth=1.5,e.setLineDash([3,3]),e.beginPath(),e.rect(o-2-r/2,c-2-r/2,d+4+r,38+r),e.stroke(),e.setLineDash([])}o+=d+5})})};l();let k=setInterval(()=>{r.clearRect(0,0,e.width,e.height),r.globalAlpha=1,r.globalCompositeOperation="source-over",r.setTransform(1,0,0,1,0,0),r.scale(a,a),g(r,s,i),h(r,s),y(r,s,c.keyStates)},1e3/30);return()=>{u(),window.removeEventListener("resize",d),clearInterval(k)}},[m,p,t,c.keyStates,f,l,u]),(0,n.jsx)("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center",margin:"10px auto 30px",padding:0,position:"relative",overflow:"visible"},className:i,children:(0,n.jsx)("canvas",{ref:o,style:{display:"block",width:"800px",height:"280px",imageRendering:"pixelated"},"aria-label":"レトロスタイルのタイピングキーボード（Worker対応）"})})},h=()=>{let[e,t]=(0,a.useState)({nextKey:"a",lastPressedKey:"",isError:!1,score:0}),{animationState:r,startAnimation:s}=d(),{effectsState:o,startEffects:c,addKeyEffect:l,playSound:h}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,a.useRef)(null),[r,n]=(0,a.useState)({isRunning:!1,effects:[],lastUpdate:0,config:{soundEnabled:!0,visualEffectsEnabled:!0,...e}}),s=(0,a.useRef)(null);(0,a.useRef)({});let i=(0,a.useRef)([]);(0,a.useEffect)(()=>{let e=new u("/workers/effects-worker.js");t.current=e;let a=e.addEventListener("EFFECTS_UPDATE",e=>{n(t=>({...t,effects:e.effects||t.effects,lastUpdate:e.timestamp||Date.now()}))});if(i.current.push(a),r.config.soundEnabled&&"undefined"!=typeof AudioContext)try{s.current=new AudioContext}catch(e){console.warn("[useEffectsWorker] AudioContext初期化エラー:",e)}return e.initialize(),()=>{s.current&&s.current.close().catch(console.error),i.current.forEach(e=>e()),i.current=[],e&&e.terminate()}},[r.config.soundEnabled]);let o=(0,a.useCallback)(()=>{t.current&&!r.isRunning&&t.current.sendMessage("START_EFFECTS",{config:r.config},e=>{e.success&&n(e=>({...e,isRunning:!0}))})},[r.config,r.isRunning]),c=(0,a.useCallback)(()=>{t.current&&r.isRunning&&t.current.sendMessage("STOP_EFFECTS",{},e=>{e.success&&n(e=>({...e,isRunning:!1}))})},[r.isRunning]),l=(0,a.useCallback)(e=>{t.current&&r.isRunning&&(r.config.soundEnabled&&"keydown"===e.type&&h(e.key,e.correct),t.current.sendMessage("PROCESS_KEY_EVENT",e))},[r.config.soundEnabled,r.isRunning]),d=(0,a.useCallback)(e=>{t.current&&r.isRunning&&(t.current.sendMessage("ADD_EFFECT",e),e.sound&&r.config.soundEnabled&&f(e.sound))},[r.config.soundEnabled,r.isRunning]),g=(0,a.useCallback)(e=>{n(t=>({...t,config:{...t.config,...e}})),t.current&&t.current.sendMessage("UPDATE_CONFIG",{config:{...r.config,...e}})},[r.config]),h=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(s.current)try{let e=s.current.createOscillator(),r=s.current.createGain();t?(e.type="sine",e.frequency.setValueAtTime(440+100*Math.random(),s.current.currentTime),r.gain.setValueAtTime(.1,s.current.currentTime)):(e.type="sawtooth",e.frequency.setValueAtTime(220+50*Math.random(),s.current.currentTime),r.gain.setValueAtTime(.07,s.current.currentTime)),r.gain.exponentialRampToValueAtTime(.001,s.current.currentTime+.1),e.connect(r),r.connect(s.current.destination),e.start(),e.stop(s.current.currentTime+.1)}catch(e){console.warn("[useEffectsWorker] サウンド再生エラー:",e)}},f=e=>{if(s.current)try{let t=s.current.createOscillator(),r=s.current.createGain();switch(e){case"success":t.type="sine",t.frequency.setValueAtTime(880,s.current.currentTime),t.frequency.exponentialRampToValueAtTime(440,s.current.currentTime+.2),r.gain.setValueAtTime(.2,s.current.currentTime),r.gain.exponentialRampToValueAtTime(.001,s.current.currentTime+.2);break;case"error":t.type="sawtooth",t.frequency.setValueAtTime(220,s.current.currentTime),r.gain.setValueAtTime(.15,s.current.currentTime),r.gain.exponentialRampToValueAtTime(.001,s.current.currentTime+.3);break;default:t.type="triangle",t.frequency.setValueAtTime(600,s.current.currentTime),r.gain.setValueAtTime(.1,s.current.currentTime),r.gain.exponentialRampToValueAtTime(.001,s.current.currentTime+.1)}t.connect(r),r.connect(s.current.destination),t.start(),t.stop(s.current.currentTime+.3)}catch(e){console.warn("[useEffectsWorker] エフェクトサウンド再生エラー:",e)}};return{effects:r.effects,isRunning:r.isRunning,config:r.config,startEffects:o,stopEffects:c,processKeyEvent:l,addEffect:d,updateConfig:g}}();(0,a.useEffect)(()=>{s(),c();let r=r=>{let n=r.key.toLowerCase(),s=n===e.nextKey.toLowerCase();t(e=>({...e,lastPressedKey:n,isError:!s,score:s?e.score+1:e.score,nextKey:s?f():e.nextKey})),l(n,!s)};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[s,c,l,e.nextKey]);let f=()=>{let e="abcdefghijklmnopqrstuvwxyz";return e.charAt(Math.floor(Math.random()*e.length))};return(0,n.jsxs)("div",{className:"jsx-92c9c050417d907 typing-game-container",children:[(0,n.jsx)("h1",{className:"jsx-92c9c050417d907",children:"Worker対応タイピングゲーム"}),(0,n.jsxs)("div",{className:"jsx-92c9c050417d907 typing-stats",children:[(0,n.jsxs)("p",{className:"jsx-92c9c050417d907",children:["スコア: ",e.score]}),(0,n.jsxs)("p",{className:"jsx-92c9c050417d907",children:["次のキー: ",e.nextKey.toUpperCase()]}),e.lastPressedKey&&(0,n.jsxs)("p",{className:"jsx-92c9c050417d907",children:["最後に押されたキー: ",e.lastPressedKey.toUpperCase(),e.isError?" (不正解)":" (正解)"]})]}),(0,n.jsx)(g,{nextKey:e.nextKey,lastPressedKey:e.lastPressedKey,isError:e.isError}),(0,n.jsx)("div",{className:"jsx-92c9c050417d907 debug-info",children:(0,n.jsxs)("details",{className:"jsx-92c9c050417d907",children:[(0,n.jsx)("summary",{className:"jsx-92c9c050417d907",children:"デバッグ情報"}),(0,n.jsxs)("p",{className:"jsx-92c9c050417d907",children:["アニメーションWorker: ",r.isRunning?"実行中":"停止"]}),(0,n.jsxs)("p",{className:"jsx-92c9c050417d907",children:["エフェクトWorker: ",o.isRunning?"実行中":"停止"]}),(0,n.jsxs)("p",{className:"jsx-92c9c050417d907",children:["アクティブエフェクト数: ",o.effects.length]})]})}),(0,n.jsx)(i(),{id:"92c9c050417d907",children:".typing-game-container.jsx-92c9c050417d907{display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-webkit-flex-direction:column;-moz-box-orient:vertical;-moz-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-webkit-align-items:center;-moz-box-align:center;-ms-flex-align:center;align-items:center;max-width:800px;margin:0 auto;padding:20px}.typing-stats.jsx-92c9c050417d907{margin-bottom:20px;padding:15px;background:rgba(10,13,20,.8);-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;width:100%}.typing-stats.jsx-92c9c050417d907 p.jsx-92c9c050417d907{margin:5px 0}.debug-info.jsx-92c9c050417d907{margin-top:20px;width:100%;font-size:.9rem;color:#888}"})]})}},7062:(e,t,r)=>{r.d(t,{A2:()=>i,LV:()=>d});let n=Symbol("Comlink.proxy"),s=Symbol("Comlink.endpoint"),i=Symbol("Comlink.releaseProxy"),a=Symbol("Comlink.finalizer"),o=Symbol("Comlink.thrown"),c=e=>"object"==typeof e&&null!==e||"function"==typeof e,l=new Map([["proxy",{canHandle:e=>c(e)&&e[n],serialize(e){let{port1:t,port2:r}=new MessageChannel;return function e(t,r=globalThis,s=["*"]){r.addEventListener("message",function i(c){let l;if(!c||!c.data)return;if(!function(e,t){for(let r of e)if(t===r||"*"===r||r instanceof RegExp&&r.test(t))return!0;return!1}(s,c.origin))return void console.warn(`Invalid origin '${c.origin}' for comlink proxy`);let{id:d,type:g,path:h}=Object.assign({path:[]},c.data),f=(c.data.argumentList||[]).map(b);try{var p,m,E;let r=h.slice(0,-1).reduce((e,t)=>e[t],t),s=h.reduce((e,t)=>e[t],t);switch(g){case"GET":l=s;break;case"SET":r[h.slice(-1)[0]]=b(c.data.value),l=!0;break;case"APPLY":l=s.apply(r,f);break;case"CONSTRUCT":p=new s(...f),l=Object.assign(p,{[n]:!0});break;case"ENDPOINT":{let{port1:r,port2:n}=new MessageChannel;e(t,n),m=r,E=[r],y.set(m,E),l=m}break;case"RELEASE":l=void 0;break;default:return}}catch(e){l={value:e,[o]:0}}Promise.resolve(l).catch(e=>({value:e,[o]:0})).then(e=>{let[n,s]=k(e);r.postMessage(Object.assign(Object.assign({},n),{id:d}),s),"RELEASE"===g&&(r.removeEventListener("message",i),u(r),a in t&&"function"==typeof t[a]&&t[a]())}).catch(e=>{let[t,n]=k({value:TypeError("Unserializable return value"),[o]:0});r.postMessage(Object.assign(Object.assign({},t),{id:d}),n)})}),r.start&&r.start()}(e,t),[r,[r]]},deserialize:e=>(e.start(),d(e))}],["throw",{canHandle:e=>c(e)&&o in e,serialize({value:e}){let t;return[e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[]]},deserialize(e){if(e.isError)throw Object.assign(Error(e.value.message),e.value);throw e.value}}]]);function u(e){"MessagePort"===e.constructor.name&&e.close()}function d(e,t){let r=new Map;return e.addEventListener("message",function(e){let{data:t}=e;if(!t||!t.id)return;let n=r.get(t.id);if(n)try{n(t)}finally{r.delete(t.id)}}),function e(t,r,n=[],a=function(){}){let o=!1,c=new Proxy(a,{get(s,a){if(g(o),a===i)return()=>{p&&p.unregister(c),h(t),r.clear(),o=!0};if("then"===a){if(0===n.length)return{then:()=>c};let e=E(t,r,{type:"GET",path:n.map(e=>e.toString())}).then(b);return e.then.bind(e)}return e(t,r,[...n,a])},set(e,s,i){g(o);let[a,c]=k(i);return E(t,r,{type:"SET",path:[...n,s].map(e=>e.toString()),value:a},c).then(b)},apply(i,a,c){g(o);let l=n[n.length-1];if(l===s)return E(t,r,{type:"ENDPOINT"}).then(b);if("bind"===l)return e(t,r,n.slice(0,-1));let[u,d]=m(c);return E(t,r,{type:"APPLY",path:n.map(e=>e.toString()),argumentList:u},d).then(b)},construct(e,s){g(o);let[i,a]=m(s);return E(t,r,{type:"CONSTRUCT",path:n.map(e=>e.toString()),argumentList:i},a).then(b)}}),l=(f.get(t)||0)+1;return f.set(t,l),p&&p.register(c,t,c),c}(e,r,[],t)}function g(e){if(e)throw Error("Proxy has been released and is not useable")}function h(e){return E(e,new Map,{type:"RELEASE"}).then(()=>{u(e)})}let f=new WeakMap,p="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{let t=(f.get(e)||0)-1;f.set(e,t),0===t&&h(e)});function m(e){var t;let r=e.map(k);return[r.map(e=>e[0]),(t=r.map(e=>e[1]),Array.prototype.concat.apply([],t))]}let y=new WeakMap;function k(e){for(let[t,r]of l)if(r.canHandle(e)){let[n,s]=r.serialize(e);return[{type:"HANDLER",name:t,value:n},s]}return[{type:"RAW",value:e},y.get(e)||[]]}function b(e){switch(e.type){case"HANDLER":return l.get(e.name).deserialize(e.value);case"RAW":return e.value}}function E(e,t,r,n){return new Promise(s=>{let i=[,,,,].fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");t.set(i,s),e.start&&e.start(),e.postMessage(Object.assign({id:i},r),n)})}}}]);