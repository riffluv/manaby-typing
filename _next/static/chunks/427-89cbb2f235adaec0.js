"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[427],{1427:(e,t,r)=>{r.d(t,{z:()=>u});var n=r(2115),o=r(9980),a=r(5792),l=r(3712);r(1603);let s={playSound:()=>{}};function u(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{initialProblem:t=null,playSound:r=!0,soundSystem:u=s,onProblemComplete:c=()=>{},onDebugInfoUpdate:i=null}=e,p=(0,n.useRef)({}),m=(0,n.useCallback)(e=>{let{type:t,progress:r}=e;if("completed"===t){let e=C.recordProblemCompletion();c({problemKeyCount:e.problemKeyCount,problemElapsedMs:e.problemElapsedMs,problemKPM:e.problemKPM,updatedProblemKPMs:[],problemStats:[]})}},[c]),d=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{initialProblem:t=null,onProblemStateChange:r=()=>{},onSessionInitialized:a=()=>{}}=e||{},l=(0,n.useCallback)(function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n]},[!1]),s=(0,n.useRef)(null),u=(0,n.useRef)(!1),[c,i]=(0,n.useState)(!1),[p,m]=(0,n.useState)(!1),d=(0,n.useRef)({initTime:0,lastUpdateTime:0,errorCount:0,hasValidRomaji:!1}),[C,y]=(0,n.useState)({romaji:"",typedLength:0,currentInputLength:0,currentCharIndex:0,currentInput:"",expectedNextChar:"",currentCharRomaji:"",updated:Date.now()}),[g,f]=(0,n.useState)(0),k=(0,n.useCallback)(e=>!!e&&!!e.kanaText&&"string"==typeof e.kanaText&&!!e.displayText&&"string"==typeof e.displayText,[]),b=(0,n.useCallback)(e=>{if(!k(e))return console.warn("[useTypingCore] 無効な問題データです",e?JSON.stringify(e).substring(0,100):"undefined"),!1;d.current.initTime=Date.now(),l("問題データ初期化:",{displayText:e.displayText,kanaText:e.kanaText?e.kanaText.length>20?e.kanaText.substring(0,20)+"...":e.kanaText:"<なし>",timestamp:new Date().toLocaleTimeString()});try{var t,r,n,c;s.current&&l("既存セッションをクリーンアップします");let p=o.A.createTypingSession(e);if(!p)return console.error("[useTypingCore] セッションの作成に失敗しました"),d.current.errorCount++,!1;s.current=p,u.current=!1;let C=p.getColoringInfo(),g=C&&"string"==typeof C.romaji&&C.romaji.length>0;d.current.hasValidRomaji=g,g||console.warn("[useTypingCore] 有効なローマ字データが取得できませんでした",C),l("初期化時の表示情報:",{romaji:C&&C.romaji?C.romaji.substring(0,30)+(C.romaji.length>30?"...":""):"<なし>",currentCharIndex:null!=(t=null==C?void 0:C.currentCharIndex)?t:0,expectedNextChar:null!=(r=null==C?void 0:C.expectedNextChar)?r:"",valid:!!C&&"string"==typeof C.romaji});let k={romaji:(null==C?void 0:C.romaji)||"",typedLength:0,currentInputLength:null!=(n=null==C?void 0:C.currentInputLength)?n:0,currentCharIndex:null!=(c=null==C?void 0:C.currentCharIndex)?c:0,currentInput:(null==C?void 0:C.currentInput)||"",expectedNextChar:(null==C?void 0:C.expectedNextChar)||"",currentCharRomaji:(null==C?void 0:C.currentCharRomaji)||"",updated:Date.now()};return k.romaji||(console.warn("[useTypingCore] 表示用ローマ字が生成されませんでした"),k.romaji=""),y(k),f(0),m(!1),i(!0),a(p),!0}catch(e){return console.error("[useTypingCore] セッション初期化エラー:",e),!1}},[k]),h=(0,n.useCallback)(e=>{y(e)},[]),v=(0,n.useCallback)(e=>{try{m(e),!0===e&&(u.current=!0)}catch(e){console.error("[useTypingCore] 完了状態の更新でエラーが発生しました:",e)}},[!1]),S=(0,n.useCallback)(()=>s.current&&s.current.getCurrentExpectedKey()||"",[]),x=(0,n.useCallback)(()=>s.current?s.current.getCompletionPercentage():0,[]),T=(0,n.useCallback)(()=>{u.current||(u.current=!0,m(!0),f(100),r({type:"completed",progress:100}))},[r]);return(0,n.useEffect)(()=>{if(t){var e;c&&(null==t?void 0:t.displayText)===(null==(e=s.current)?void 0:e.displayText)||b(t)}},[t,b,c]),{isInitialized:c,isCompleted:p,displayInfo:C,progressPercentage:g,sessionRef:s,completedRef:u,initializeSession:b,markAsCompleted:T,getExpectedNextKey:S,getProgress:x,setDisplayData:h,setCompleted:v,setDisplayInfo:y,setProgressPercentage:f}}({initialProblem:t,onProblemStateChange:m,onSessionInitialized:e=>{C.resetStats()}}),C=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{onStatsUpdate:t=()=>{},updateInterval:r=250}=e,s=(0,n.useRef)({correctKeyCount:0,mistakeCount:0,startTime:null,currentProblemStartTime:null,problemStats:[]}),[u,c]=(0,n.useState)({correctKeyCount:0,mistakeCount:0,kpm:0,rank:"F"}),i=(0,n.useRef)(null),p=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=s.current;s.current={correctKeyCount:0,mistakeCount:0,startTime:null,currentProblemStartTime:null,previousProblemMistakeCount:e&&t.mistakeCount||0,problemStats:e&&t.problemStats||[]},c({correctKeyCount:0,mistakeCount:0,kpm:0,rank:"F"})},[]),m=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now(),t=s.current;t.startTime||(t.startTime=e,t.currentProblemStartTime=e),t.correctKeyCount+=1,i.current||(i.current=setTimeout(()=>{C(),i.current=null},r))},[]),d=(0,n.useCallback)(()=>{s.current.mistakeCount+=1,c(e=>({...e,mistakeCount:s.current.mistakeCount}))},[]),C=(0,n.useCallback)(async()=>{let e;s.current.workerInitialized||(a.A.initialize(),s.current.workerInitialized=!0);let r=s.current,n=r.correctKeyCount,u=r.mistakeCount,i=n+u,p=r.startTime||Date.now(),m=Date.now()-p;try{e=await a.A.calculateKPM({keyCount:n,elapsedTimeMs:m,correctKeyCount:n,totalKeyCount:i,mistakeCount:u}),(0,l.Sz)()}catch(l){console.error("[useTypingStats] KPM計算でエラー発生:",l);let t=m/6e4,r=t>0?Math.max(1,Math.floor(n/t)):0,a=o.A.getRank(r);e={kpm:r,rank:a}}let d={correctKeyCount:n,mistakeCount:u,kpm:e.kpm,rank:e.rank,accuracy:e.accuracy};return c(d),t(d),d},[t]),y=(0,n.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{timestamp:t=Date.now()}=e,r=s.current,n=r.currentProblemStartTime?t-r.currentProblemStartTime:0,l=r.correctKeyCount||0,u=r.mistakeCount||0;r.workerInitialized||(a.A.initialize(),r.workerInitialized=!0);let c=0;try{c=(await a.A.calculateKPM({keyCount:l,elapsedTimeMs:n,mistakeCount:u,correctKeyCount:l,totalKeyCount:l+u})).kpm}catch(e){console.error("[useTypingStats] 問題KPM計算エラー:",e),c=n>0?Math.floor(l/(n/6e4)):0}let i={problemKeyCount:l,problemElapsedMs:n,problemMistakeCount:u,problemKPM:c,timestamp:t},p=[...r.problemStats||[],i];r.problemStats=p;let m=0,d="F";try{let e=await a.A.calculateAverageKPM(p);m=e.kpm,d=e.rank}catch(e){console.error("[useTypingStats] 平均KPM計算エラー:",e),m=o.A.calculateAverageKPM(p),d=o.A.getRank(m)}return C(),{problemKeyCount:i.problemKeyCount,problemElapsedMs:i.problemElapsedMs,problemKPM:i.problemKPM,problemMistakeCount:i.problemMistakeCount,correctKeyCount:r.correctKeyCount,mistakeCount:r.mistakeCount,averageKPM:m,rank:d}},[C]);return(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;console.log("[useTypingStats] ".concat(e,"文字スキップしました"))},[]),(0,n.useEffect)(()=>(a.A.initialize(),s.current.workerInitialized=!0,()=>{if(i.current&&(clearTimeout(i.current),i.current=null),s.current.workerInitialized)try{a.A.cleanup(),s.current.workerInitialized=!1}catch(e){console.error("[useTypingStats] ScoreCalculationWorkerクリーンアップエラー:",e)}}),[]),{statsRef:s,displayStats:u,resetStats:p,countCorrectKey:m,countMistake:d,updateDisplayStats:C,recordProblemCompletion:y,recordMistake:(0,n.useCallback)(()=>d(),[d]),getLatestStats:(0,n.useCallback)(()=>({...u,correctKeyCount:s.current.correctKeyCount,mistakeCount:s.current.mistakeCount}),[u]),recordSkip:(0,n.useCallback)(function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]},[]),recordCorrectKey:(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now();return m(e)},[m])}}({onStatsUpdate:e=>{if(i){let t={...p.current,stats:e};p.current=t,i(t)}}}),y=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{sessionRef:t,isCompleted:r,completedRef:o,onCorrectInput:a=()=>{},onIncorrectInput:l=()=>{},onComplete:s=()=>{},onLineEnd:u=()=>{},playSound:c=!0,soundSystem:i=null,updateInterval:p=16}=e||{},m=(0,n.useCallback)(function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n]},[!1]),d=(0,n.useRef)({totalKeyPresses:0,correctKeyPresses:0,incorrectKeyPresses:0,lastKeyTime:0,averageLatency:0}),[C,y]=(0,n.useState)({points:0,combo:0,maxCombo:0}),[g,f]=(0,n.useState)(!1),k=(0,n.useRef)(null),[b,h]=(0,n.useState)(""),v=(0,n.useRef)(null);(0,n.useRef)(!1);let S=(0,n.useCallback)(()=>{f(!0),k.current&&clearTimeout(k.current),k.current=setTimeout(()=>{f(!1),k.current=null},150)},[]),x=(0,n.useCallback)(()=>{let e=null==t?void 0:t.current;if(e&&(null==o||!o.current)&&!r&&"function"==typeof e.update)try{let t=performance.now(),[r,o]=e.update(t);if(r){var n,a,l,c,i,p;m("行の更新:",{leftover:o}),u({timestamp:t,leftover:o,completed:(null==(n=e.isCompleted)?void 0:n.call(e))||!1,combo:(null==(a=e.getCombo)?void 0:a.call(e))||0,maxCombo:(null==(l=e.getMaxCombo)?void 0:l.call(e))||0}),(null==(c=e.isCompleted)?void 0:c.call(e))&&s({result:{status:"time_completed"},progress:100,combo:(null==(i=e.getCombo)?void 0:i.call(e))||0,maxCombo:(null==(p=e.getMaxCombo)?void 0:p.call(e))||0}),I()}}catch(e){console.error("[useTypingInput] 更新処理エラー:",e)}},[t,o,r,u,s]),T=(0,n.useCallback)(()=>{v.current&&clearInterval(v.current),v.current=setInterval(()=>{x()},p),x()},[x,p]),I=(0,n.useCallback)(()=>{var e,r;let n=null==t?void 0:t.current;if(!n)return;let o=(null==(e=n.getCombo)?void 0:e.call(n))||0,a=(null==(r=n.getMaxCombo)?void 0:r.call(n))||0;y(e=>e.combo===o&&e.maxCombo===a?e:{...e,combo:o,maxCombo:a})},[t]),K=(0,n.useCallback)(e=>{if("string"!=typeof e)return m("無効なキー入力:",e),{success:!1,reason:"invalid_key"};if(o.current||r)return{success:!1,reason:"session_completed"};let n=t.current;if(!n)return{success:!1,reason:"session_not_found"};performance.now(),queueMicrotask(()=>{d.current.totalKeyPresses++,d.current.lastKeyTime=Date.now(),h(t=>t!==e?e:t)});try{var u,p,C,y,g,f,k;let t;if(Date.now(),"function"==typeof n.accept){let r=n.accept(e);1===r?(t={success:!0,status:"input_accepted"},(null==(u=n.isCompleted)?void 0:u.call(n))&&(t.status="all_completed")):t=-1===r?{success:!1,status:"wrong_input"}:{success:!1,status:"invalid_input"}}else{if("function"!=typeof n.processInput)return{success:!1,reason:"invalid_session"};t=n.processInput(e)}if(t.success){queueMicrotask(()=>{d.current.correctKeyPresses++}),c&&i&&("function"==typeof i.ultraFastPlayTypingSound?i.ultraFastPlayTypingSound("success"):"function"==typeof i.playSound&&i.playSound("success"));let r={},o=0;try{r=(null==(C=n.getColoringInfo)?void 0:C.call(n))||{},o=(null==(y=n.getCompletionPercentage)?void 0:y.call(n))||0}catch(e){console.error("[useTypingInput] 情報取得エラー:",e)}let l={romaji:r.romaji||"",typedLength:r.typedLength||0,currentInputLength:r.currentInputLength||0,currentCharIndex:r.currentCharIndex||0,currentInput:r.currentInput||"",expectedNextChar:r.expectedNextChar||"",currentCharRomaji:r.currentCharRomaji||"",updated:Date.now()};return I(),a({key:e,displayInfo:l,progress:o,result:t}),("all_completed"===t.status||(null==(p=n.isCompleted)?void 0:p.call(n))===!0)&&s({result:{status:"all_completed"},displayInfo:l,progress:100,combo:(null==(g=n.getCombo)?void 0:g.call(n))||0,maxCombo:(null==(f=n.getMaxCombo)?void 0:f.call(n))||0}),{success:!0,displayInfo:l,progress:o}}{c&&i&&("function"==typeof i.ultraFastPlayTypingSound?i.ultraFastPlayTypingSound("error"):"function"==typeof i.playSound&&i.playSound("error")),S(),I();let t=(null==(k=n.getCurrentExpectedKey)?void 0:k.call(n))||"";return l({key:e,expectedKey:t,timestamp:Date.now()}),{success:!1,reason:"incorrect_input"}}}catch(e){return console.error("[useTypingInput] 入力処理エラー:",e),{success:!1,reason:"processing_error",error:e}}},[t,o,r,c,i,S,a,l,s,I]);return(0,n.useEffect)(()=>(T(),()=>{k.current&&(clearTimeout(k.current),k.current=null),v.current&&(clearInterval(v.current),v.current=null)}),[T]),{handleInput:K,errorAnimation:g,lastPressedKey:b,setLastPressedKey:h,score:C,updateSession:x}}({sessionRef:d.sessionRef,isCompleted:d.isCompleted,completedRef:d.completedRef,playSound:r,soundSystem:u,onCorrectInput:e=>{let{key:t,displayInfo:r,progress:n}=e;Math.abs(n-d.progressPercentage)>5&&d.setProgressPercentage(n),d.setDisplayData(r),C.recordCorrectKey()},onIncorrectInput:()=>{C.recordMistake()},onComplete:e=>{let{result:t,displayInfo:r,progress:n,combo:o,maxCombo:a}=e;try{d&&"function"==typeof d.setCompleted?(d.setCompleted(!0),d.completedRef&&(d.completedRef.current=!0)):console.warn("[useTypingGame] typingCore.setCompletedが未定義です"),d&&"function"==typeof d.setProgressPercentage&&d.setProgressPercentage(100),d&&"function"==typeof d.setDisplayData&&d.setDisplayData(r)}catch(e){console.error("[useTypingGame] 完了処理中にエラーが発生しました:",e)}m({type:"completed",progress:100,combo:o,maxCombo:a})},onLineEnd:e=>{let{leftover:t,completed:r,combo:n,maxCombo:o}=e;t>0&&C.recordSkip(t),r&&m({type:"completed",progress:100,combo:n,maxCombo:o})}}),g=(0,n.useCallback)(e=>{d.sessionRef.current&&!d.isCompleted&&y.updateSession&&y.updateSession(e)},[d.sessionRef,d.isCompleted,y]),f=(0,n.useCallback)(()=>{try{var e,t,r;let n=null==d||null==(e=d.sessionRef)?void 0:e.current;if(!n)return{combo:0,maxCombo:0,score:0,rank:"F"};let o={combo:(null==(t=n.getCombo)?void 0:t.call(n))||0,maxCombo:(null==(r=n.getMaxCombo)?void 0:r.call(n))||0};if(!C||"function"!=typeof C.getLatestStats)return{...o,score:0,rank:"F"};{let e=C.getLatestStats()||{};return{...o,...e,score:e.kpm?Math.floor(e.kpm*(o.maxCombo||1)):0,rank:e.rank||"F"}}}catch(e){return console.error("[useTypingGame] スコア情報の取得中にエラーが発生しました:",e),{combo:0,maxCombo:0,score:0,rank:"F"}}},[null==d?void 0:d.sessionRef,C]);(0,n.useEffect)(()=>{if(!d.sessionRef.current)return;let e=null,t=r=>{g(r),e=requestAnimationFrame(t)};return e=requestAnimationFrame(t),()=>{null!==e&&cancelAnimationFrame(e)}},[d.sessionRef,g]),(0,n.useEffect)(()=>{if(!i)return;let e={session:d.sessionRef.current?{completed:d.isCompleted,progress:d.progressPercentage,displayData:d.displayData}:null,stats:C.getLatestStats(),input:{lastKey:y.lastPressedKey,errorState:y.errorAnimation},score:f()};p.current=e,i(e)},[d.isCompleted,d.progressPercentage,d.displayData,y.lastPressedKey,y.errorAnimation,i,C,f]);let k=(0,n.useCallback)(e=>{C.resetStats();let t=d.initializeSession(e);if(t&&d.sessionRef.current){let e=d.sessionRef.current.getColoringInfo();d.setDisplayInfo({romaji:e.romaji||"",typedLength:0,currentInputLength:e.currentInputLength||0,currentCharIndex:e.currentCharIndex||0,currentInput:e.currentInput||"",expectedNextChar:e.expectedNextChar||"",currentCharRomaji:e.currentCharRomaji||""})}return t},[d,C]),b=(0,n.useCallback)(()=>d.getExpectedNextKey(),[d]);return{isInitialized:d.isInitialized,isCompleted:d.isCompleted,displayInfo:d.displayInfo||{romaji:"",typedLength:0,currentInputLength:0,currentCharIndex:0},displayStats:C.displayStats||{},progressPercentage:d.progressPercentage||0,errorAnimation:y.errorAnimation||!1,lastPressedKey:y.lastPressedKey||"",typingSession:d.sessionRef.current,typingSessionRef:d.sessionRef,typingStats:C,statsRef:C.statsRef,handleInput:y.handleInput,setProblem:k,getNextKey:b,resetStats:C.resetStats,updateDisplayStats:C.updateDisplayStats,performanceMetrics:{get inputLatency(){return p.current.inputLatency},set inputLatency(value){p.current.inputLatency=value,i&&i(p.current)}}}}}}]);