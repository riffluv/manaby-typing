<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>タイピングゲーム パフォーマンステスト</title>
  <style>
    body {
      font-family: 'Meiryo', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f8f9fa;
    }

    .test-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    button {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 10px;
    }

    button:hover {
      background-color: #3367d6;
    }

    pre {
      background: #f1f3f4;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .results {
      margin-top: 20px;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 8px;
      background: #f1f3f4;
      border-radius: 4px;
    }

    .metric-name {
      font-weight: bold;
    }

    .good {
      color: #0d652d;
    }

    .warn {
      color: #a50e0e;
    }
  </style>
</head>

<body>
  <h1>タイピングゲーム パフォーマンステスト</h1>

  <div class="test-panel">
    <h2>最適化テスト</h2>
    <p>ボタンをクリックして、タイピングゲームのパフォーマンスをテストします。</p>

    <button id="runSimpleTest">簡易テスト実行</button>
    <button id="runExtendedTest">拡張テスト実行</button>
    <button id="runStressTest">ストレステスト実行</button>

    <div class="results">
      <h3>テスト結果</h3>
      <div id="testResults">テストを実行してください...</div>
    </div>
  </div>

  <div class="test-panel">
    <h2>コンソール出力</h2>
    <pre id="consoleOutput">--- パフォーマンスログはここに表示されます ---</pre>
  </div>

  <script type="module">
    // タイピングゲームのパフォーマンステストページ
    // 実際のuseTypingGameフックを使用してパフォーマンスをテストします

    // モックデータ
    const mockProblem = {
      displayText: "こんにちは、世界！タイピングゲームのパフォーマンステストです。",
      kanaText: "こんにちは、せかい！たいぴんぐげーむのぱふぉーまんすてすとです。",
      id: "test-problem-1"
    };

    // ロギングをキャプチャ
    const originalConsoleLog = console.log;
    const originalConsoleDebug = console.debug;
    const consoleOutput = document.getElementById('consoleOutput');

    function captureConsole() {
      console.log = function (...args) {
        const message = args.map(arg =>
          typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
        ).join(' ');
        consoleOutput.textContent += message + '\n';
        originalConsoleLog.apply(console, args);
      };

      console.debug = function (...args) {
        const message = args.map(arg =>
          typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
        ).join(' ');
        consoleOutput.textContent += '[DEBUG] ' + message + '\n';
        originalConsoleDebug.apply(console, args);
      };
    }

    // PerfTestUtilsをインポート
    async function runTests() {
      try {
        captureConsole();
        consoleOutput.textContent = "--- テスト開始 ---\n";

        // 動的にモジュールをインポート
        const { useTypingGame } = await import('../hooks/useTypingGame.js');

        // モックReactフックを作成
        function mockUseState(initialValue) {
          let value = initialValue;
          const setValue = (newValue) => {
            if (typeof newValue === 'function') {
              value = newValue(value);
            } else {
              value = newValue;
            }
          };
          return [value, setValue];
        }

        function mockUseRef(initialValue) {
          return { current: initialValue };
        }

        function mockUseCallback(callback, deps) {
          return callback;
        }

        function mockUseMemo(factory, deps) {
          return factory();
        }

        function mockUseEffect(effect, deps) {
          effect();
        }

        // テスト実行関数
        window.runSimpleTest = async function () {
          clearResults();
          consoleOutput.textContent = "--- 簡易テスト開始 ---\n";

          const inputs = generateTypingInputs(50);  // 50キー分の入力
          const result = await runTypingTest(inputs);
          displayResults(result);
        };

        window.runExtendedTest = async function () {
          clearResults();
          consoleOutput.textContent = "--- 拡張テスト開始 ---\n";

          const inputs = generateTypingInputs(200);  // 200キー分の入力
          const result = await runTypingTest(inputs);
          displayResults(result);
        };

        window.runStressTest = async function () {
          clearResults();
          consoleOutput.textContent = "--- ストレステスト開始 ---\n";

          const inputs = generateTypingInputs(500);  // 500キー分の入力
          const result = await runTypingTest(inputs);
          displayResults(result);
        };

        // テスト実行
        async function runTypingTest(inputs) {
          console.log(`テスト実行: ${inputs.length}キー入力`);

          // タイピングゲームフックの初期化
          const typingGame = useTypingGame({
            initialProblem: mockProblem,
            playSound: false,
            onProblemComplete: (stats) => {
              console.log('問題完了:', stats);
            }
          });

          console.log('タイピングセッション初期化完了');

          // パフォーマンステスト実行
          const testResult = await typingGame.runPerfTest(inputs);
          console.log('テスト完了:', testResult);

          return testResult;
        }

        // ランダム入力生成
        function generateTypingInputs(length = 100) {
          const letters = 'abcdefghijklmnopqrstuvwxyz,.';
          const inputs = [];

          for (let i = 0; i < length; i++) {
            inputs.push(letters[Math.floor(Math.random() * letters.length)]);
          }

          return inputs;
        }

        // 結果表示
        function displayResults(results) {
          const resultsDiv = document.getElementById('testResults');
          if (!results) {
            resultsDiv.innerHTML = '<p>テスト実行中にエラーが発生しました。</p>';
            return;
          }

          const avgInputTime = results.averageInputTime.toFixed(2);
          const successRate = ((results.successCount / results.totalInputs) * 100).toFixed(1);
          const avgFrameTime = results.averageFrameTime ? results.averageFrameTime.toFixed(2) : 'N/A';
          const fps = avgFrameTime !== 'N/A' ? (1000 / avgFrameTime).toFixed(1) : 'N/A';

          let html = '';
          html += createMetric('総入力数', `${results.totalInputs}キー`, '');
          html += createMetric('成功率', `${successRate}%`, successRate > 90 ? 'good' : 'warn');
          html += createMetric('総処理時間', `${results.totalDuration.toFixed(0)}ms`, '');
          html += createMetric('平均入力処理時間', `${avgInputTime}ms`, avgInputTime < 2 ? 'good' : avgInputTime < 5 ? '' : 'warn');
          html += createMetric('平均フレーム時間', `${avgFrameTime}ms`, avgFrameTime < 16 ? 'good' : 'warn');
          html += createMetric('推定FPS', `${fps}`, fps > 30 ? 'good' : 'warn');
          html += createMetric('フレームドロップ', `${results.frameDrops || 0}回`, results.frameDrops < 5 ? 'good' : 'warn');

          resultsDiv.innerHTML = html;
        }

        function createMetric(name, value, className) {
          return `<div class="metric">
                        <span class="metric-name">${name}:</span>
                        <span class="${className}">${value}</span>
                    </div>`;
        }

        function clearResults() {
          document.getElementById('testResults').innerHTML = 'テスト実行中...';
        }

        // イベントリスナー設定
        document.getElementById('runSimpleTest').addEventListener('click', window.runSimpleTest);
        document.getElementById('runExtendedTest').addEventListener('click', window.runExtendedTest);
        document.getElementById('runStressTest').addEventListener('click', window.runStressTest);

        console.log('パフォーマンステスト準備完了。ボタンをクリックしてテストを実行してください。');
      } catch (error) {
        console.error('テスト初期化エラー:', error);
        consoleOutput.textContent += `エラー: ${error.message}\n${error.stack}\n`;
      }
    }

    // テスト初期化
    runTests();
  </script>
</body>

</html>